<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Platos · Configurador (Local)</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>

  <body class="bg-zinc-50 text-zinc-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      /**********************
       * Utils
       **********************/
      const LS_KEY = "platos_app_v3_dates_weights";
      // Migración desde posibles keys viejas (si alguna vez cambiaste la key)
      const LS_KEYS_OLD = [
        "platos_app_v3",
        "platos_app_v2_dates_weights",
        "platos_app_v2_dates",
        "platos_app_v2",
        "platos_app_v1",
      ];

      const uid = () => Math.random().toString(36).slice(2, 10);
      const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

      function safeJsonParse(s, fallback) {
        try { return JSON.parse(s); } catch { return fallback; }
      }
      function round(n, d=0) {
        if (!isFinite(n)) return 0;
        const m = Math.pow(10, d);
        return Math.round(n*m)/m;
      }
      function downloadText(filename, text, mime="text/plain") {
        const blob = new Blob([text], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      function toCSV(rows) {
        const esc = (v) => {
          const s = String(v ?? "");
          if (/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
          return s;
        };
        return rows.map(r => r.map(esc).join(",")).join("\n");
      }

      function pad2(n){ return String(n).padStart(2,"0"); }
      function todayStr(){
        const d = new Date();
        const y = d.getFullYear();
        const m = pad2(d.getMonth()+1);
        const da = pad2(d.getDate());
        return `${y}-${m}-${da}`;
      }
      function weekdayLabel(dateStr){
        const d = new Date(dateStr + "T00:00:00");
        const days = ["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];
        return days[d.getDay()];
      }
      function monthLabel(ym){
        // ym = YYYY-MM
        const [y,m] = ym.split("-");
        const months = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        const mi = parseInt(m,10)-1;
        return `${months[mi] ?? m} ${y}`;
      }

      /**********************
       * WHO BMI (adult)
       **********************/
      function bmiCategoryWHO(bmi) {
        if (!isFinite(bmi) || bmi <= 0) return { label: "—", key: "na" };
        if (bmi < 18.5) return { label: "Bajo peso (<18.5)", key: "under" };
        if (bmi < 25) return { label: "Normopeso (18.5–24.9)", key: "normal" };
        if (bmi < 30) return { label: "Sobrepeso (25–29.9)", key: "over" };
        if (bmi < 35) return { label: "Obesidad I (30–34.9)", key: "ob1" };
        if (bmi < 40) return { label: "Obesidad II (35–39.9)", key: "ob2" };
        return { label: "Obesidad III (≥40)", key: "ob3" };
      }

      /**********************
       * Calorie estimation (practical)
       **********************/
      const ACTIVITY = [
        { key: "sed", label: "Sedentario", factor: 1.2 },
        { key: "light", label: "Ligero (1–3 días/sem)", factor: 1.375 },
        { key: "mod", label: "Moderado (3–5 días/sem)", factor: 1.55 },
        { key: "high", label: "Alto (6–7 días/sem)", factor: 1.725 },
        { key: "ath", label: "Muy alto (doble sesión)", factor: 1.9 },
      ];
      function bmrMifflin({ sex, weightKg, heightCm, age }) {
        if (!(weightKg>0 && heightCm>0 && age>0)) return 0;
        const s = sex === "f" ? -161 : 5;
        return 10*weightKg + 6.25*heightCm - 5*age + s;
      }
      function goalAdjust(goalKey) {
        if (goalKey === "lose") return -450;
        if (goalKey === "lose_fast") return -650;
        if (goalKey === "gain") return +250;
        return 0;
      }
      function proteinPerKg(goalKey) {
        if (goalKey.startsWith("lose")) return 2.0;
        if (goalKey === "gain") return 1.8;
        return 1.6;
      }

      /**********************
       * Data Model
       **********************/
      const CATS = [
        { key: "proteina", label: "Proteína" },
        { key: "vegetal", label: "Vegetal" },
        { key: "fruta", label: "Fruta" },
        { key: "hidrato", label: "Hidrato" },
        { key: "infusion", label: "Infusión" },
        { key: "extra", label: "Extra" },
      ];
      const UNITS = [
        { key: "g", label: "g" },
        { key: "ml", label: "ml" },
        { key: "u", label: "u" },
      ];

      // ✅ NUEVO ORDEN + RENOMBRE + "OTROS"
      // Nota: ya no existe "principal"; se usa "almuerzo"
      const MEAL_TYPES = [
        { key: "desayuno", label: "Desayuno", slots: ["proteina", "fruta", "infusion", "extra"] },
        { key: "almuerzo", label: "Almuerzo", slots: ["proteina", "vegetal", "vegetal", "hidrato", "infusion", "extra"] },
        { key: "merienda", label: "Merienda", slots: ["proteina", "fruta", "infusion", "extra"] },
        { key: "cena", label: "Cena", slots: ["proteina", "vegetal", "vegetal", "infusion", "extra"] },
        { key: "otros", label: "Otros", slots: ["proteina", "fruta", "extra", "infusion"] },
      ];

      function defaultIngredients() {
        return [
          // Proteínas
          { id: uid(), name: "Pollo (pechuga)", category:"proteina", unit:"g", portionDefault:180, kcalPer100:165 },
          { id: uid(), name: "Carne magra", category:"proteina", unit:"g", portionDefault:180, kcalPer100:190 },
          { id: uid(), name: "Pescado", category:"proteina", unit:"g", portionDefault:200, kcalPer100:140 },
          { id: uid(), name: "Huevo", category:"proteina", unit:"u", portionDefault:2, kcalPerUnit:70 },
          { id: uid(), name: "Yogurt griego natural", category:"proteina", unit:"g", portionDefault:220, kcalPer100:70 },

          // Vegetales
          { id: uid(), name: "Ensalada mixta", category:"vegetal", unit:"g", portionDefault:300, kcalPer100:25 },
          { id: uid(), name: "Brócoli", category:"vegetal", unit:"g", portionDefault:300, kcalPer100:35 },
          { id: uid(), name: "Zapallito", category:"vegetal", unit:"g", portionDefault:300, kcalPer100:20 },

          // Frutas
          { id: uid(), name: "Manzana", category:"fruta", unit:"u", portionDefault:1, kcalPerUnit:95 },
          { id: uid(), name: "Banana chica", category:"fruta", unit:"u", portionDefault:1, kcalPerUnit:90 },
          { id: uid(), name: "Frutos rojos", category:"fruta", unit:"g", portionDefault:120, kcalPer100:50 },

          // Hidratos
          { id: uid(), name: "Arroz cocido", category:"hidrato", unit:"g", portionDefault:160, kcalPer100:130 },
          { id: uid(), name: "Papa al horno", category:"hidrato", unit:"g", portionDefault:200, kcalPer100:110 },

          // Infusiones
          { id: uid(), name: "Mate", category:"infusion", unit:"ml", portionDefault:300, kcalPer100:0 },
          { id: uid(), name: "Café", category:"infusion", unit:"ml", portionDefault:200, kcalPer100:0 },
          { id: uid(), name: "Té", category:"infusion", unit:"ml", portionDefault:250, kcalPer100:0 },

          // Extras
          { id: uid(), name: "Almendras", category:"extra", unit:"g", portionDefault:15, kcalPer100:580 },
          { id: uid(), name: "Aceite de oliva", category:"extra", unit:"g", portionDefault:10, kcalPer100:884 },

          // Alcohol (ejemplo)
          { id: uid(), name: "Vino tinto (seco)", category:"extra", unit:"ml", portionDefault:150, kcalPer100:85 },
          { id: uid(), name: "Vino blanco (seco)", category:"extra", unit:"ml", portionDefault:150, kcalPer100:82 },
        ];
      }

      function defaultProfiles() {
        const t = todayStr();
        return [
          {
            id: uid(),
            name: "Darío",
            sex: "m",
            age: 35,
            heightCm: 178,
            weightKg: 92,
            activityKey: "mod",
            goalKey: "lose",
            // Registro inicial automático (peso inicial)
            weightLog: [{ date: t, weight: 92 }],
          }
        ];
      }

      // Plan por perfil: fechas reales
      function makeEmptyPlanDates() {
        const t = todayStr();
        return {
          selectedDate: t,
          dateList: [t],
          selectedForShopping: { [t]: true },
          mealsByDate: { [t]: [] },
        };
      }

      function defaultState() {
        const prof = defaultProfiles();
        return {
          profiles: prof,
          activeProfileId: prof[0]?.id ?? null,
          ingredients: defaultIngredients(),
          plansByProfileId: {},
        };
      }

      /**********************
       * Porciones por escenario
       **********************/
      function kcalBand(targetKcal) {
        if (!isFinite(targetKcal) || targetKcal <= 0) return "mid";
        if (targetKcal < 1800) return "low";
        if (targetKcal < 2400) return "mid";
        return "high";
      }

      // ✅ Cambiamos "principal" -> "almuerzo" y agregamos "otros"
      const PORTION_MULT = {
        desayuno: { proteina:{low:0.9, mid:1.0, high:1.1}, fruta:{low:0.9, mid:1.0, high:1.15}, infusion:{low:1, mid:1, high:1}, extra:{low:0.8, mid:1.0, high:1.0} },
        merienda: { proteina:{low:0.9, mid:1.0, high:1.1}, fruta:{low:0.9, mid:1.0, high:1.15}, infusion:{low:1, mid:1, high:1}, extra:{low:0.8, mid:1.0, high:1.0} },
        cena: { proteina:{low:0.9, mid:1.0, high:1.1}, vegetal:{low:1.0, mid:1.1, high:1.2}, infusion:{low:1, mid:1, high:1}, extra:{low:0.8, mid:1.0, high:1.0} },

        almuerzo: { proteina:{low:0.95, mid:1.05, high:1.2}, vegetal:{low:1.0, mid:1.15, high:1.3}, hidrato:{low:0.7, mid:1.0, high:1.25}, infusion:{low:1, mid:1, high:1}, extra:{low:0.8, mid:1.0, high:1.0} },

        otros: { proteina:{low:0.7, mid:0.8, high:0.9}, fruta:{low:0.7, mid:0.8, high:0.9}, infusion:{low:1, mid:1, high:1}, extra:{low:0.6, mid:0.7, high:0.8} },
      };

      function suggestQty({ ing, mealType, slotCat, targetKcal, vegSlotCount=1 }) {
        if (!ing) return 0;
        const band = kcalBand(targetKcal);
        const def = ing.portionDefault ?? 0;
        const m = (PORTION_MULT[mealType]?.[slotCat]?.[band]) ?? 1.0;

        if (slotCat === "vegetal" && vegSlotCount > 1) {
          const total = def * m * 1.2;
          return round(total / vegSlotCount, 0);
        }
        return round(def * m, 0);
      }

      /**********************
       * Meal kcal
       **********************/
      function kcalForItem(ing, qty) {
        if (!ing) return 0;
        if (ing.unit === "u") {
          const perU = ing.kcalPerUnit ?? 0;
          return (qty ?? 0) * perU;
        }
        const per100 = ing.kcalPer100 ?? 0;
        return ((qty ?? 0) * per100) / 100;
      }
      function mealTotals(meal, ingById) {
        let kcal = 0;
        for (const it of meal.items) {
          const ing = ingById[it.ingredientId];
          kcal += kcalForItem(ing, it.qty);
        }
        return { kcal: round(kcal, 0) };
      }

      /**********************
       * Weight stats (monthly + bars)
       **********************/
      function sortWeightLog(log) {
        const arr = Array.isArray(log) ? [...log] : [];
        arr.sort((a,b)=> String(a.date).localeCompare(String(b.date)));
        return arr.filter(x => x?.date && isFinite(x?.weight));
      }
      function upsertWeight(log, entry) {
        const arr = Array.isArray(log) ? [...log] : [];
        const idx = arr.findIndex(x => x.date === entry.date);
        if (idx >= 0) arr[idx] = entry;
        else arr.push(entry);
        return sortWeightLog(arr);
      }
      function monthlyLast(log) {
        const sorted = sortWeightLog(log);
        const byMonth = new Map();
        for (const e of sorted) {
          const ym = e.date.slice(0,7);
          const cur = byMonth.get(ym);
          if (!cur || e.date >= cur.date) byMonth.set(ym, { ...e });
        }
        const months = Array.from(byMonth.entries())
          .map(([ym, v]) => ({ ym, date: v.date, weight: v.weight }))
          .sort((a,b)=> a.ym.localeCompare(b.ym));
        return months;
      }
      function diffMonths(ymA, ymB) {
        const [y1,m1] = ymA.split("-").map(Number);
        const [y2,m2] = ymB.split("-").map(Number);
        return (y2 - y1)*12 + (m2 - m1);
      }
      function computeWeightStats(log) {
        const sorted = sortWeightLog(log);
        if (!sorted.length) return null;

        const initial = sorted[0].weight;
        const current = sorted[sorted.length-1].weight;
        const totalDelta = round(current - initial, 1);

        const months = monthlyLast(sorted);
        const monthlyDeltas = months.map(m => ({
          ...m,
          deltaVsInitial: round(m.weight - initial, 1),
        }));

        let avgPerMonth = 0;
        if (months.length >= 2) {
          const span = Math.max(1, diffMonths(months[0].ym, months[months.length-1].ym));
          avgPerMonth = round((months[months.length-1].weight - months[0].weight) / span, 2);
        }

        let best = null, worst = null;
        for (let i=1;i<months.length;i++){
          const change = round(months[i].weight - months[i-1].weight, 1);
          const obj = { ym: months[i].ym, change };
          if (!best || change < best.change) best = obj;
          if (!worst || change > worst.change) worst = obj;
        }

        const minW = Math.min(...months.map(m=>m.weight), initial);
        const maxW = Math.max(...months.map(m=>m.weight), initial);
        const maxLoss = Math.max(0, initial - minW);
        const maxGain = Math.max(0, maxW - initial);

        return {
          initial, current, totalDelta,
          months: monthlyDeltas,
          avgPerMonth,
          best, worst,
          maxLoss, maxGain
        };
      }

      /**********************
       * UI Components
       **********************/
      function Badge({ children }) {
        return (
          <span className="inline-flex items-center rounded-full bg-zinc-100 px-2.5 py-1 text-xs font-medium text-zinc-700">
            {children}
          </span>
        );
      }
      function Card({ title, right, children }) {
        return (
          <div className="rounded-2xl bg-white shadow-sm border border-zinc-100">
            <div className="flex items-center justify-between px-4 py-3 border-b border-zinc-100">
              <div className="font-semibold">{title}</div>
              <div>{right}</div>
            </div>
            <div className="p-4">{children}</div>
          </div>
        );
      }
      function TextField({ label, value, onChange, placeholder }) {
        return (
          <label className="block">
            <div className="text-xs font-semibold text-zinc-700 mb-1">{label}</div>
            <input
              className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-200"
              value={value}
              placeholder={placeholder}
              onChange={(e)=> onChange(e.target.value)}
            />
          </label>
        );
      }
      function NumberField({ label, value, onChange, min, max, step=1, suffix }) {
        const [txt, setTxt] = useState(String(value ?? ""));
        useEffect(() => setTxt(String(value ?? "")), [value]);
        return (
          <label className="block">
            <div className="text-xs font-semibold text-zinc-700 mb-1">{label}</div>
            <div className="flex items-center gap-2">
              <input
                className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-200"
                inputMode="decimal"
                value={txt}
                onChange={(e)=> setTxt(e.target.value)}
                onBlur={()=>{
                  const n = parseFloat(String(txt).replace(",", "."));
                  if (!isFinite(n)) { setTxt(String(value ?? "")); return; }
                  const nn = clamp(n, min ?? -1e9, max ?? 1e9);
                  onChange(nn);
                }}
              />
              {suffix ? <span className="text-sm text-zinc-500">{suffix}</span> : null}
            </div>
          </label>
        );
      }
      function Select({ label, value, onChange, options }) {
        return (
          <label className="block">
            {label ? <div className="text-xs font-semibold text-zinc-700 mb-1">{label}</div> : null}
            <select
              className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-200"
              value={value}
              onChange={(e)=> onChange(e.target.value)}
            >
              {options.map(o => (
                <option key={o.key} value={o.key}>{o.label}</option>
              ))}
            </select>
          </label>
        );
      }

      /**********************
       * Migration helpers
       **********************/
      function findStoredState() {
        // 1) intento la key actual
        let raw = localStorage.getItem(LS_KEY);
        if (raw) return raw;

        // 2) si no, busco keys viejas
        for (const k of LS_KEYS_OLD) {
          const old = localStorage.getItem(k);
          if (old) return old;
        }
        return null;
      }

      function migrateMealTypeKey(mealType) {
        // compatibilidad: si antes guardaste "principal", ahora es "almuerzo"
        if (mealType === "principal") return "almuerzo";
        return mealType;
      }

      function migrateState(st) {
        const base = defaultState();
        if (!st || typeof st !== "object") return base;

        const migrated = { ...base, ...st };

        if (!Array.isArray(migrated.profiles) || !migrated.profiles.length) migrated.profiles = base.profiles;
        if (!Array.isArray(migrated.ingredients) || !migrated.ingredients.length) migrated.ingredients = base.ingredients;
        if (!migrated.activeProfileId) migrated.activeProfileId = migrated.profiles[0]?.id ?? null;
        if (!migrated.plansByProfileId) migrated.plansByProfileId = {};

        // Ensure weightLog exists (baseline)
        const t = todayStr();
        migrated.profiles = migrated.profiles.map(p => {
          const wl = sortWeightLog(p.weightLog);
          if (wl.length) return { ...p, weightLog: wl };
          const w = isFinite(p.weightKg) ? p.weightKg : 0;
          return { ...p, weightLog: w>0 ? [{ date: t, weight: w }] : [] };
        });

        // Ensure plan exists per profile + migrate meal types inside meals
        for (const p of migrated.profiles) {
          if (!migrated.plansByProfileId[p.id]) migrated.plansByProfileId[p.id] = makeEmptyPlanDates();

          const pl = migrated.plansByProfileId[p.id];
          if (pl?.mealsByDate) {
            const mealsByDate = { ...pl.mealsByDate };
            for (const ds of Object.keys(mealsByDate)) {
              mealsByDate[ds] = (mealsByDate[ds] ?? []).map(m => ({
                ...m,
                type: migrateMealTypeKey(m.type),
              }));
            }
            migrated.plansByProfileId[p.id] = { ...pl, mealsByDate };
          }
        }

        return migrated;
      }

      /**********************
       * App
       **********************/
      function App() {
        const [state, setState] = useState(() => {
          const raw = findStoredState();
          const st = raw ? safeJsonParse(raw, null) : null;
          return migrateState(st);
        });

        // Guardamos SIEMPRE en la key actual
        useEffect(() => {
          localStorage.setItem(LS_KEY, JSON.stringify(state));
        }, [state]);

        const profiles = state.profiles;
        const activeProfile = profiles.find(p => p.id === state.activeProfileId) ?? profiles[0] ?? null;

        const ingById = useMemo(() => {
          const m = {};
          for (const i of state.ingredients) m[i.id] = i;
          return m;
        }, [state.ingredients]);

        const ingredientsByCat = useMemo(() => {
          const m = {};
          for (const c of CATS) m[c.key] = [];
          for (const i of state.ingredients) (m[i.category] ??= []).push(i);
          for (const k of Object.keys(m)) m[k].sort((a,b)=> a.name.localeCompare(b.name));
          return m;
        }, [state.ingredients]);

        const profileStats = useMemo(() => {
          if (!activeProfile) return null;
          const hM = (activeProfile.heightCm ?? 0) / 100;
          const bmi = hM>0 ? (activeProfile.weightKg / (hM*hM)) : 0;
          const cat = bmiCategoryWHO(bmi);

          const act = ACTIVITY.find(a => a.key === activeProfile.activityKey) ?? ACTIVITY[2];
          const bmr = bmrMifflin({
            sex: activeProfile.sex,
            weightKg: activeProfile.weightKg,
            heightCm: activeProfile.heightCm,
            age: activeProfile.age,
          });
          const tdee = bmr * (act.factor ?? 1.55);
          let target = tdee + goalAdjust(activeProfile.goalKey);
          target = clamp(target, 1400, 3800);

          const protG = round(activeProfile.weightKg * proteinPerKg(activeProfile.goalKey), 0);

          return {
            bmi: round(bmi, 1),
            bmiCat: cat,
            tdee: round(tdee, 0),
            targetKcal: round(target, 0),
            proteinG: protG,
            band: kcalBand(target),
          };
        }, [activeProfile]);

        const weightStats = useMemo(() => {
          if (!activeProfile) return null;
          return computeWeightStats(activeProfile.weightLog);
        }, [activeProfile]);

        const plan = useMemo(() => {
          if (!activeProfile) return null;
          return state.plansByProfileId?.[activeProfile.id] ?? null;
        }, [state.plansByProfileId, activeProfile]);

        const [tab, setTab] = useState("armador");

        /**********************
         * Profiles
         **********************/
        function addProfile() {
          const t = todayStr();
          const p = {
            id: uid(),
            name: "Nuevo perfil",
            sex: "f",
            age: 30,
            heightCm: 165,
            weightKg: 70,
            activityKey: "light",
            goalKey: "lose",
            weightLog: [{ date: t, weight: 70 }],
          };
          setState(s => ({
            ...s,
            profiles: [...s.profiles, p],
            activeProfileId: p.id,
            plansByProfileId: { ...(s.plansByProfileId||{}), [p.id]: makeEmptyPlanDates() }
          }));
        }
        function updateProfile(id, patch) {
          setState(s => ({
            ...s,
            profiles: s.profiles.map(p => p.id === id ? { ...p, ...patch } : p)
          }));
        }
        function removeProfile(id) {
          setState(s => {
            const nextProfiles = s.profiles.filter(p => p.id !== id);
            const nextActive = s.activeProfileId === id ? (nextProfiles[0]?.id ?? null) : s.activeProfileId;
            const nextPlans = { ...(s.plansByProfileId||{}) };
            delete nextPlans[id];
            return { ...s, profiles: nextProfiles, activeProfileId: nextActive, plansByProfileId: nextPlans };
          });
        }

        // Weight log actions
        const [weightDate, setWeightDate] = useState(todayStr());
        const [weightValue, setWeightValue] = useState(activeProfile?.weightKg ?? 0);

        useEffect(() => {
          setWeightDate(todayStr());
          setWeightValue(activeProfile?.weightKg ?? 0);
        }, [activeProfile?.id]);

        function saveWeightEntry() {
          if (!activeProfile) return;
          const d = String(weightDate || "").trim();
          const w = parseFloat(String(weightValue).replace(",", "."));
          if (!/^\d{4}-\d{2}-\d{2}$/.test(d)) return alert("Elegí una fecha válida.");
          if (!isFinite(w) || w <= 0) return alert("Ingresá un peso válido.");

          setState(s => {
            const nextProfiles = s.profiles.map(p => {
              if (p.id !== activeProfile.id) return p;
              const wl = upsertWeight(p.weightLog, { date: d, weight: round(w, 1) });
              const latest = wl[wl.length-1]?.weight ?? p.weightKg;
              return { ...p, weightLog: wl, weightKg: latest };
            });
            return { ...s, profiles: nextProfiles };
          });
        }

        function deleteWeightEntry(dateStr) {
          if (!activeProfile) return;
          if (!confirm("¿Eliminar este registro de peso?")) return;
          setState(s => {
            const nextProfiles = s.profiles.map(p => {
              if (p.id !== activeProfile.id) return p;
              const wl = sortWeightLog(p.weightLog).filter(e => e.date !== dateStr);
              const latest = wl.length ? wl[wl.length-1].weight : p.weightKg;
              return { ...p, weightLog: wl, weightKg: latest };
            });
            return { ...s, profiles: nextProfiles };
          });
        }

        /**********************
         * Ingredients
         **********************/
        function addIngredient() {
          setState(s => ({
            ...s,
            ingredients: [
              ...s.ingredients,
              {
                id: uid(),
                name: "Nuevo ingrediente",
                category: "proteina",
                unit: "g",
                portionDefault: 100,
                kcalPer100: 100,
              }
            ]
          }));
        }
        function updateIngredient(id, patch) {
          setState(s => ({
            ...s,
            ingredients: s.ingredients.map(i => i.id === id ? { ...i, ...patch } : i)
          }));
        }
        function removeIngredient(id) {
          setState(s => {
            const nextIngredients = s.ingredients.filter(i => i.id !== id);
            const nextPlans = { ...(s.plansByProfileId||{}) };
            for (const pid of Object.keys(nextPlans)) {
              const pl = nextPlans[pid];
              if (!pl?.mealsByDate) continue;
              const mealsByDate = { ...pl.mealsByDate };
              for (const ds of Object.keys(mealsByDate)) {
                mealsByDate[ds] = (mealsByDate[ds] ?? []).map(meal => ({
                  ...meal,
                  items: (meal.items ?? []).filter(it => it.ingredientId !== id)
                }));
              }
              nextPlans[pid] = { ...pl, mealsByDate };
            }
            return { ...s, ingredients: nextIngredients, plansByProfileId: nextPlans };
          });
        }

        /**********************
         * Dates + Meals
         **********************/
        const selectedDate = plan?.selectedDate ?? todayStr();
        const dateList = plan?.dateList ?? [todayStr()];
        const mealsToday = plan?.mealsByDate?.[selectedDate] ?? [];

        function setSelectedDate(ds) {
          if (!activeProfile) return;
          setState(s => {
            const pl = s.plansByProfileId?.[activeProfile.id] ?? makeEmptyPlanDates();
            const mealsByDate = { ...(pl.mealsByDate ?? {}) };
            if (!mealsByDate[ds]) mealsByDate[ds] = [];
            const dateList2 = pl.dateList?.includes(ds) ? pl.dateList : [ds, ...(pl.dateList ?? [])];
            const selShop = { ...(pl.selectedForShopping ?? {}) };
            if (selShop[ds] === undefined) selShop[ds] = true;
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [activeProfile.id]: { ...pl, selectedDate: ds, dateList: dateList2, mealsByDate, selectedForShopping: selShop }
              }
            };
          });
        }
        function addDateToList(ds) {
          if (!activeProfile) return;
          setState(s => {
            const pl = s.plansByProfileId?.[activeProfile.id] ?? makeEmptyPlanDates();
            const dateList2 = pl.dateList?.includes(ds) ? pl.dateList : [ds, ...(pl.dateList ?? [])];
            const mealsByDate = { ...(pl.mealsByDate ?? {}) };
            if (!mealsByDate[ds]) mealsByDate[ds] = [];
            const selShop = { ...(pl.selectedForShopping ?? {}) };
            if (selShop[ds] === undefined) selShop[ds] = true;
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [activeProfile.id]: { ...pl, dateList: dateList2, mealsByDate, selectedForShopping: selShop }
              }
            };
          });
        }
        function toggleShopDate(ds) {
          if (!activeProfile) return;
          setState(s => {
            const pl = s.plansByProfileId?.[activeProfile.id] ?? makeEmptyPlanDates();
            const sel = { ...(pl.selectedForShopping ?? {}) };
            sel[ds] = !sel[ds];
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [activeProfile.id]: { ...pl, selectedForShopping: sel }
              }
            };
          });
        }
        function selectOnlyTodayForShopping() {
          if (!activeProfile) return;
          setState(s => {
            const pl = s.plansByProfileId?.[activeProfile.id] ?? makeEmptyPlanDates();
            const sel = {};
            for (const ds of (pl.dateList ?? [])) sel[ds] = false;
            sel[pl.selectedDate] = true;
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [activeProfile.id]: { ...pl, selectedForShopping: sel }
              }
            };
          });
        }
        function selectAllForShopping(v=true) {
          if (!activeProfile) return;
          setState(s => {
            const pl = s.plansByProfileId?.[activeProfile.id] ?? makeEmptyPlanDates();
            const sel = { ...(pl.selectedForShopping ?? {}) };
            for (const ds of (pl.dateList ?? [])) sel[ds] = v;
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [activeProfile.id]: { ...pl, selectedForShopping: sel }
              }
            };
          });
        }

        /**********************
         * Builder
         **********************/
        const [builderType, setBuilderType] = useState("desayuno");
        const builderDef = MEAL_TYPES.find(m => m.key === builderType) ?? MEAL_TYPES[0];

        const [builderItems, setBuilderItems] = useState(() =>
          builderDef.slots.map(cat => ({ slotCat: cat, ingredientId:"", qty:0 }))
        );

        useEffect(() => {
          setBuilderItems(builderDef.slots.map(cat => ({ slotCat: cat, ingredientId:"", qty:0 })));
          // eslint-disable-next-line
        }, [builderType]);

        const targetKcal = profileStats?.targetKcal ?? 2100;

        function pickIngredient(slotIdx, ingredientId) {
          const slotCat = builderDef.slots[slotIdx];
          const ing = ingById[ingredientId];
          const vegSlots = builderDef.slots.filter(s => s === "vegetal").length;

          setBuilderItems(prev => prev.map((it, i) => {
            if (i !== slotIdx) return it;
            const suggested = ing
              ? suggestQty({ ing, mealType: builderType, slotCat, targetKcal, vegSlotCount: vegSlots })
              : 0;
            return { ...it, ingredientId, qty: suggested };
          }));
        }
        function setQty(slotIdx, qty) {
          setBuilderItems(prev => prev.map((it, i) => i===slotIdx ? { ...it, qty } : it));
        }

        const builderMeal = useMemo(() => {
          const items = builderItems
            .filter(it => it?.ingredientId && it.qty > 0)
            .map(it => ({ ingredientId: it.ingredientId, qty: it.qty }));
          return { id: uid(), type: builderType, items, createdAt: Date.now() };
        }, [builderItems, builderType]);

        const builderTotals = useMemo(() => mealTotals(builderMeal, ingById), [builderMeal, ingById]);

        function addMealToDate() {
          if (!activeProfile) return;
          if (!builderMeal.items.length) return alert("Elegí al menos 1 ingrediente con cantidad.");
          setState(s => {
            const pid = activeProfile.id;
            const pl = s.plansByProfileId?.[pid] ?? makeEmptyPlanDates();
            const ds = pl.selectedDate ?? todayStr();
            const mealsByDate = { ...(pl.mealsByDate ?? {}) };
            const arr = [...(mealsByDate[ds] ?? [])];
            arr.push(builderMeal);
            mealsByDate[ds] = arr;
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [pid]: { ...pl, mealsByDate }
              }
            };
          });
        }

        function removeMealFromDate(idx) {
          if (!activeProfile) return;
          setState(s => {
            const pid = activeProfile.id;
            const pl = s.plansByProfileId?.[pid] ?? makeEmptyPlanDates();
            const ds = pl.selectedDate ?? todayStr();
            const mealsByDate = { ...(pl.mealsByDate ?? {}) };
            const arr = [...(mealsByDate[ds] ?? [])];
            arr.splice(idx, 1);
            mealsByDate[ds] = arr;
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [pid]: { ...pl, mealsByDate }
              }
            };
          });
        }

        const dayKcal = useMemo(() => {
          let sum = 0;
          for (const m of mealsToday) sum += mealTotals(m, ingById).kcal;
          return round(sum, 0);
        }, [mealsToday, ingById]);

        /**********************
         * Shopping list
         **********************/
        const shopping = useMemo(() => {
          if (!plan) return [];
          const sel = plan.selectedForShopping ?? {};
          const map = new Map();
          for (const ds of (plan.dateList ?? [])) {
            if (!sel[ds]) continue;
            const meals = plan.mealsByDate?.[ds] ?? [];
            for (const meal of meals) {
              for (const it of (meal.items ?? [])) {
                map.set(it.ingredientId, (map.get(it.ingredientId) ?? 0) + (it.qty ?? 0));
              }
            }
          }
          const rows = [];
          for (const [ingId, qty] of map.entries()) {
            const ing = ingById[ingId];
            if (!ing) continue;
            rows.push({
              category: ing.category,
              ingredient: ing.name,
              qty: round(qty, 0),
              unit: ing.unit,
            });
          }
          rows.sort((a,b)=> (a.category+a.ingredient).localeCompare(b.category+b.ingredient));
          return rows;
        }, [plan, ingById]);

        function exportShoppingCSV() {
          const header = [["categoria","ingrediente","cantidad","unidad"]];
          const data = shopping.map(r => [r.category, r.ingredient, r.qty, r.unit]);
          downloadText("lista_compras.csv", toCSV([...header, ...data]), "text/csv");
        }

        function exportJSON() {
          downloadText("platos_app_backup.json", JSON.stringify(state, null, 2), "application/json");
        }
        function importJSON(file) {
          const reader = new FileReader();
          reader.onload = () => {
            const obj = safeJsonParse(reader.result, null);
            if (!obj || typeof obj !== "object") return alert("JSON inválido.");
            if (!Array.isArray(obj.profiles) || !Array.isArray(obj.ingredients)) {
              return alert("El JSON no parece ser un backup de esta app.");
            }
            // pasamos por migración igualmente
            const migrated = migrateState(obj);
            setState({
              profiles: migrated.profiles,
              activeProfileId: migrated.activeProfileId ?? migrated.profiles?.[0]?.id ?? null,
              ingredients: migrated.ingredients,
              plansByProfileId: migrated.plansByProfileId ?? {},
            });
          };
          reader.readAsText(file);
        }

        /**********************
         * Render
         **********************/
        return (
          <div className="min-h-screen">
            <header className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-zinc-100">
              <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
                <div className="font-bold tracking-tight">Platos · Configurador</div>
                <Badge>localStorage</Badge>

                <div className="ml-auto flex items-center gap-2">
                  <select
                    className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm"
                    value={state.activeProfileId ?? ""}
                    onChange={(e)=> setState(s => ({ ...s, activeProfileId: e.target.value }))}
                  >
                    {profiles.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>
                  <button
                    className="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                    onClick={addProfile}
                  >
                    + Perfil
                  </button>
                </div>
              </div>

              <div className="max-w-6xl mx-auto px-4 pb-3 flex flex-wrap gap-2">
                {[
                  { key:"armador", label:"Armador" },
                  { key:"compras", label:"Compras" },
                  { key:"ingredientes", label:"Ingredientes" },
                  { key:"perfiles", label:"Perfiles" },
                ].map(t => (
                  <button
                    key={t.key}
                    onClick={()=> setTab(t.key)}
                    className={[
                      "px-3 py-1.5 rounded-full text-sm border",
                      tab===t.key ? "bg-zinc-900 text-white border-zinc-900" : "bg-white border-zinc-200 hover:bg-zinc-50"
                    ].join(" ")}
                  >
                    {t.label}
                  </button>
                ))}

                <div className="ml-auto flex items-center gap-2">
                  <button className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50" onClick={exportJSON}>
                    Exportar JSON
                  </button>
                  <label className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50 cursor-pointer">
                    Importar JSON
                    <input type="file" accept="application/json" className="hidden" onChange={(e)=> {
                      const f = e.target.files?.[0];
                      if (f) importJSON(f);
                      e.target.value = "";
                    }} />
                  </label>
                </div>
              </div>
            </header>

            <main className="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
              {/* LEFT: Profile + Weight report + calendar */}
              <div className="lg:col-span-1 space-y-4">
                <Card title="Perfil activo" right={<Badge>{activeProfile?.name ?? "—"}</Badge>}>
                  {!activeProfile ? (
                    <div className="text-sm text-zinc-600">Creá un perfil para empezar.</div>
                  ) : (
                    <div className="space-y-3">
                      <div className="grid grid-cols-2 gap-3">
                        <Select
                          label="Sexo"
                          value={activeProfile.sex}
                          onChange={(v)=> updateProfile(activeProfile.id, { sex: v })}
                          options={[
                            { key:"m", label:"Masculino" },
                            { key:"f", label:"Femenino" },
                          ]}
                        />
                        <NumberField label="Edad" value={activeProfile.age} onChange={(n)=> updateProfile(activeProfile.id, { age: n })} min={14} max={90} suffix="años" />
                        <NumberField label="Altura" value={activeProfile.heightCm} onChange={(n)=> updateProfile(activeProfile.id, { heightCm: n })} min={120} max={220} suffix="cm" />
                        <NumberField label="Peso (auto desde log)" value={activeProfile.weightKg} onChange={(n)=> updateProfile(activeProfile.id, { weightKg: n })} min={35} max={250} step={0.1} suffix="kg" />
                        <Select
                          label="Actividad"
                          value={activeProfile.activityKey}
                          onChange={(v)=> updateProfile(activeProfile.id, { activityKey: v })}
                          options={ACTIVITY.map(a => ({ key:a.key, label:`${a.label} (×${a.factor})` }))}
                        />
                        <Select
                          label="Objetivo"
                          value={activeProfile.goalKey}
                          onChange={(v)=> updateProfile(activeProfile.id, { goalKey: v })}
                          options={[
                            { key:"lose", label:"Bajar (moderado)" },
                            { key:"lose_fast", label:"Bajar (agresivo)" },
                            { key:"maintain", label:"Mantener" },
                            { key:"gain", label:"Subir (lean)" },
                          ]}
                        />
                      </div>

                      {profileStats ? (
                        <div className="rounded-xl bg-zinc-50 border border-zinc-200 p-3 space-y-2">
                          <div className="flex items-center justify-between">
                            <div className="text-sm font-semibold">IMC</div>
                            <div className="mono text-sm">{profileStats.bmi}</div>
                          </div>
                          <div className="text-sm text-zinc-700">{profileStats.bmiCat.label}</div>

                          <div className="grid grid-cols-2 gap-2 pt-2">
                            <div className="rounded-lg bg-white border border-zinc-200 p-2">
                              <div className="text-xs text-zinc-500">TDEE</div>
                              <div className="mono text-sm font-semibold">{profileStats.tdee} kcal</div>
                            </div>
                            <div className="rounded-lg bg-white border border-zinc-200 p-2">
                              <div className="text-xs text-zinc-500">Objetivo</div>
                              <div className="mono text-sm font-semibold">{profileStats.targetKcal} kcal</div>
                            </div>
                            <div className="rounded-lg bg-white border border-zinc-200 p-2 col-span-2">
                              <div className="text-xs text-zinc-500">Proteína sugerida</div>
                              <div className="mono text-sm font-semibold">{profileStats.proteinG} g/día</div>
                              <div className="text-xs text-zinc-500 mt-1">
                                Escenario porciones: <span className="mono font-semibold">{profileStats.band.toUpperCase()}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      ) : null}

                      {/* Weight report */}
                      <div className="rounded-xl bg-white border border-zinc-200 p-3 space-y-3">
                        <div className="flex items-center justify-between">
                          <div className="font-semibold">Reporte de peso</div>
                          <Badge>mensual</Badge>
                        </div>

                        <div className="grid grid-cols-2 gap-2">
                          <label className="block">
                            <div className="text-xs font-semibold text-zinc-700 mb-1">Fecha</div>
                            <input
                              type="date"
                              className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm"
                              value={weightDate}
                              onChange={(e)=> setWeightDate(e.target.value)}
                            />
                          </label>
                          <NumberField
                            label="Peso"
                            value={weightValue}
                            onChange={(n)=> setWeightValue(n)}
                            min={30} max={300}
                            step={0.1}
                            suffix="kg"
                          />
                        </div>

                        <button
                          className="w-full rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                          onClick={saveWeightEntry}
                        >
                          Guardar registro
                        </button>

                        {weightStats ? (
                          <div className="rounded-xl bg-zinc-50 border border-zinc-200 p-3 space-y-2">
                            <div className="grid grid-cols-2 gap-2">
                              <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                <div className="text-xs text-zinc-500">Inicial</div>
                                <div className="mono font-semibold">{round(weightStats.initial,1)} kg</div>
                              </div>
                              <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                <div className="text-xs text-zinc-500">Actual</div>
                                <div className="mono font-semibold">{round(weightStats.current,1)} kg</div>
                              </div>
                              <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                <div className="text-xs text-zinc-500">Variación total</div>
                                <div className={"mono font-semibold " + (weightStats.totalDelta <= 0 ? "text-emerald-700" : "text-red-700")}>
                                  {weightStats.totalDelta > 0 ? "+" : ""}{weightStats.totalDelta} kg
                                </div>
                              </div>
                              <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                <div className="text-xs text-zinc-500">Promedio</div>
                                <div className="mono font-semibold">{weightStats.avgPerMonth} kg/mes</div>
                              </div>
                            </div>

                            {/* Bars */}
                            <div className="pt-2">
                              <div className="text-xs font-semibold text-zinc-700 mb-2">Evolución por mes (vs inicial)</div>

                              <div className="space-y-2">
                                {weightStats.months.map(m => {
                                  const delta = m.deltaVsInitial;
                                  const isDown = delta <= 0;
                                  const mag = Math.abs(delta);
                                  const denom = isDown ? (weightStats.maxLoss || 1) : (weightStats.maxGain || 1);
                                  const pct = clamp((mag / denom) * 100, 0, 100);

                                  return (
                                    <div key={m.ym} className="grid grid-cols-12 gap-2 items-center">
                                      <div className="col-span-4 text-xs text-zinc-600">
                                        {monthLabel(m.ym)}
                                      </div>
                                      <div className="col-span-6">
                                        <div className="h-3 rounded-full bg-white border border-zinc-200 overflow-hidden">
                                          <div
                                            className={"h-full " + (isDown ? "bg-emerald-500" : "bg-red-500")}
                                            style={{ width: pct + "%" }}
                                          />
                                        </div>
                                      </div>
                                      <div className="col-span-2 mono text-xs text-right">
                                        {delta > 0 ? "+" : ""}{delta} kg
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>

                              {weightStats.best || weightStats.worst ? (
                                <div className="mt-3 grid grid-cols-2 gap-2">
                                  <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                    <div className="text-xs text-zinc-500">Mejor mes</div>
                                    <div className="text-sm font-semibold">
                                      {weightStats.best ? `${monthLabel(weightStats.best.ym)} (${weightStats.best.change} kg)` : "—"}
                                    </div>
                                  </div>
                                  <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                    <div className="text-xs text-zinc-500">Peor mes</div>
                                    <div className="text-sm font-semibold">
                                      {weightStats.worst ? `${monthLabel(weightStats.worst.ym)} (+${weightStats.worst.change} kg)` : "—"}
                                    </div>
                                  </div>
                                </div>
                              ) : null}
                            </div>

                            {/* Log table */}
                            <div className="pt-3">
                              <div className="text-xs font-semibold text-zinc-700 mb-2">Registros (últimos 10)</div>
                              <div className="space-y-1">
                                {sortWeightLog(activeProfile.weightLog).slice(-10).reverse().map(e => (
                                  <div key={e.date} className="flex items-center justify-between rounded-lg bg-white border border-zinc-200 px-2 py-1">
                                    <div className="text-xs text-zinc-600">{e.date}</div>
                                    <div className="flex items-center gap-2">
                                      <div className="mono text-xs font-semibold">{round(e.weight,1)} kg</div>
                                      <button
                                        className="text-xs text-red-700 border border-red-200 rounded-md px-2 py-0.5 hover:bg-red-50"
                                        onClick={()=> deleteWeightEntry(e.date)}
                                      >
                                        borrar
                                      </button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                              <div className="text-xs text-zinc-500 mt-2">
                                Tip: si cargás la misma fecha, se reemplaza.
                              </div>
                            </div>
                          </div>
                        ) : (
                          <div className="text-sm text-zinc-600">
                            Cargá al menos 1 registro para ver el reporte.
                          </div>
                        )}
                      </div>

                      <button
                        className="w-full rounded-xl border border-red-200 bg-white px-3 py-2 text-sm text-red-700 hover:bg-red-50"
                        onClick={()=> { if (confirm("¿Eliminar este perfil?")) removeProfile(activeProfile.id); }}
                      >
                        Eliminar perfil
                      </button>
                    </div>
                  )}
                </Card>

                {activeProfile && tab === "armador" ? (
                  <Card title="Calendario" right={<Badge>{selectedDate}</Badge>}>
                    <div className="grid grid-cols-1 gap-3">
                      <div className="flex items-end gap-2">
                        <label className="block flex-1">
                          <div className="text-xs font-semibold text-zinc-700 mb-1">Elegir fecha</div>
                          <input
                            type="date"
                            className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm"
                            value={selectedDate}
                            onChange={(e)=> setSelectedDate(e.target.value)}
                          />
                        </label>
                        <button
                          className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50"
                          onClick={()=> setSelectedDate(todayStr())}
                        >
                          Hoy
                        </button>
                        <button
                          className="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                          onClick={()=> addDateToList(selectedDate)}
                        >
                          + Guardar
                        </button>
                      </div>

                      <div className="text-xs text-zinc-500">
                        Guardá varios días y tildá cuáles sumar para la compra.
                      </div>

                      <div className="flex flex-wrap gap-2">
                        {(dateList ?? []).map(ds => (
                          <button
                            key={ds}
                            onClick={()=> setSelectedDate(ds)}
                            className={[
                              "px-3 py-1.5 rounded-full text-sm border",
                              ds===selectedDate ? "bg-zinc-900 text-white border-zinc-900" : "bg-white border-zinc-200 hover:bg-zinc-50"
                            ].join(" ")}
                          >
                            {weekdayLabel(ds)} {ds}
                          </button>
                        ))}
                      </div>

                      <div className="flex items-center justify-between">
                        <div className="text-sm text-zinc-600">Total kcal (fecha)</div>
                        <div className="mono text-lg font-semibold">{dayKcal}</div>
                      </div>
                      {profileStats ? (
                        <div className="text-sm text-zinc-600">
                          Objetivo: <span className="mono font-semibold">{profileStats.targetKcal}</span> kcal
                          {" · "}
                          Dif:{" "}
                          <span className={"mono font-semibold " + (dayKcal > profileStats.targetKcal ? "text-red-600" : "text-emerald-600")}>
                            {dayKcal - profileStats.targetKcal}
                          </span>
                        </div>
                      ) : null}
                    </div>
                  </Card>
                ) : null}
              </div>

              {/* RIGHT */}
              <div className="lg:col-span-2 space-y-4">
                {tab === "armador" && activeProfile ? (
                  <>
                    <Card
                      title="Armador de comidas"
                      right={
                        <div className="w-56">
                          <Select
                            label=""
                            value={builderType}
                            onChange={setBuilderType}
                            options={MEAL_TYPES.map(m => ({ key:m.key, label:m.label }))}
                          />
                        </div>
                      }
                    >
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {builderDef.slots.map((cat, idx) => {
                          const slot = builderItems[idx] ?? { ingredientId:"", qty:0 };
                          const list = ingredientsByCat[cat] ?? [];
                          const catLabel = CATS.find(c => c.key===cat)?.label ?? cat;

                          return (
                            <div key={idx} className="rounded-xl border border-zinc-200 bg-zinc-50 p-3">
                              <div className="flex items-center justify-between mb-2">
                                <div className="text-xs font-semibold text-zinc-700">
                                  {catLabel} <span className="text-zinc-400">· slot {idx+1}</span>
                                </div>
                                <Badge>{cat}</Badge>
                              </div>

                              <select
                                className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm"
                                value={slot.ingredientId ?? ""}
                                onChange={(e)=> pickIngredient(idx, e.target.value)}
                              >
                                <option value="">— elegir —</option>
                                {list.map(ing => <option key={ing.id} value={ing.id}>{ing.name}</option>)}
                              </select>

                              <div className="mt-2 grid grid-cols-2 gap-2 items-end">
                                <NumberField
                                  label="Cantidad (según perfil)"
                                  value={slot.qty ?? 0}
                                  onChange={(n)=> setQty(idx, n)}
                                  min={0} max={5000}
                                  suffix={slot.ingredientId ? (ingById[slot.ingredientId]?.unit ?? "") : ""}
                                />
                                <div className="rounded-xl border border-zinc-200 bg-white p-2">
                                  <div className="text-xs text-zinc-500">kcal (slot)</div>
                                  <div className="mono font-semibold">
                                    {round(kcalForItem(ingById[slot.ingredientId], slot.qty), 0)}
                                  </div>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>

                      <div className="mt-4 flex flex-wrap items-center gap-3">
                        <div className="rounded-xl border border-zinc-200 bg-white px-3 py-2">
                          <div className="text-xs text-zinc-500">kcal comida</div>
                          <div className="mono text-lg font-semibold">{builderTotals.kcal}</div>
                        </div>

                        <button
                          className="rounded-xl bg-emerald-600 text-white px-4 py-2 text-sm font-semibold hover:bg-emerald-500"
                          onClick={addMealToDate}
                        >
                          + Agregar a {selectedDate}
                        </button>

                        <button
                          className="rounded-xl border border-zinc-200 bg-white px-4 py-2 text-sm hover:bg-zinc-50"
                          onClick={()=> setBuilderItems(builderDef.slots.map(cat => ({ slotCat: cat, ingredientId:"", qty:0 })))}
                        >
                          Limpiar
                        </button>
                      </div>
                    </Card>

                    <Card title={`Comidas del ${weekdayLabel(selectedDate)} ${selectedDate}`} right={<Badge>{mealsToday.length} items</Badge>}>
                      {mealsToday.length === 0 ? (
                        <div className="text-sm text-zinc-600">Todavía no cargaste comidas para esta fecha.</div>
                      ) : (
                        <div className="space-y-3">
                          {mealsToday.map((m, idx) => {
                            const typeKey = migrateMealTypeKey(m.type);
                            const def = MEAL_TYPES.find(x => x.key===typeKey);
                            const tot = mealTotals({ ...m, type: typeKey }, ingById);

                            return (
                              <div key={m.id} className="rounded-xl border border-zinc-200 bg-white p-3">
                                <div className="flex items-center justify-between">
                                  <div className="font-semibold">{def?.label ?? typeKey}</div>
                                  <div className="flex items-center gap-2">
                                    <Badge>{tot.kcal} kcal</Badge>
                                    <button
                                      className="rounded-lg px-2 py-1 text-sm border border-red-200 text-red-700 hover:bg-red-50"
                                      onClick={()=> removeMealFromDate(idx)}
                                    >
                                      Quitar
                                    </button>
                                  </div>
                                </div>
                                <div className="mt-2 text-sm text-zinc-700">
                                  {(m.items ?? []).map((it, i) => {
                                    const ing = ingById[it.ingredientId];
                                    return (
                                      <div key={i} className="flex items-center justify-between border-b last:border-b-0 border-zinc-100 py-1">
                                        <div>{ing?.name ?? "?"}</div>
                                        <div className="mono text-zinc-600">
                                          {round(it.qty, 0)} {ing?.unit ?? ""}
                                          {" · "}
                                          {round(kcalForItem(ing, it.qty), 0)} kcal
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </Card>
                  </>
                ) : null}

                {tab === "compras" && activeProfile ? (
                  <Card
                    title="Lista de compras (sumando fechas seleccionadas)"
                    right={
                      <div className="flex items-center gap-2">
                        <button className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50" onClick={()=> selectAllForShopping(true)}>
                          Seleccionar todo
                        </button>
                        <button className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50" onClick={selectOnlyTodayForShopping}>
                          Solo hoy
                        </button>
                        <button
                          className="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                          onClick={exportShoppingCSV}
                        >
                          Descargar CSV
                        </button>
                      </div>
                    }
                  >
                    <div className="mb-3">
                      <div className="text-sm font-semibold mb-2">Fechas incluidas en la compra</div>
                      <div className="flex flex-wrap gap-2">
                        {(dateList ?? []).map(ds => (
                          <label key={ds} className="flex items-center gap-2 rounded-full border border-zinc-200 bg-white px-3 py-1.5 text-sm cursor-pointer">
                            <input
                              type="checkbox"
                              checked={!!(plan?.selectedForShopping?.[ds])}
                              onChange={()=> toggleShopDate(ds)}
                            />
                            <span>{weekdayLabel(ds)} {ds}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    {shopping.length === 0 ? (
                      <div className="text-sm text-zinc-600">
                        No hay comidas cargadas en las fechas seleccionadas. Cargá comidas y/o tildá fechas.
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="text-left text-zinc-500">
                              <th className="py-2">Categoría</th>
                              <th>Ingrediente</th>
                              <th className="text-right">Cantidad</th>
                              <th className="text-right">Unidad</th>
                            </tr>
                          </thead>
                          <tbody>
                            {shopping.map((r, i) => (
                              <tr key={i} className="border-t border-zinc-100">
                                <td className="py-2">{r.category}</td>
                                <td>{r.ingredient}</td>
                                <td className="text-right mono">{r.qty}</td>
                                <td className="text-right">{r.unit}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </Card>
                ) : null}

                {tab === "ingredientes" ? (
                  <Card
                    title="Ingredientes permitidos (editable)"
                    right={
                      <button
                        className="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                        onClick={addIngredient}
                      >
                        + Ingrediente
                      </button>
                    }
                  >
                    <div className="text-sm text-zinc-600 mb-3">
                      Biblioteca editable. La porción sugerida se adapta al escenario del perfil (LOW/MID/HIGH).
                    </div>

                    <div className="space-y-3">
                      {state.ingredients.map(ing => {
                        const isUnit = ing.unit === "u";
                        return (
                          <div key={ing.id} className="rounded-xl border border-zinc-200 bg-white p-3">
                            <div className="flex items-center justify-between gap-3">
                              <div className="flex-1">
                                <TextField label="Nombre" value={ing.name} onChange={(v)=> updateIngredient(ing.id, { name: v })} />
                              </div>
                              <button
                                className="mt-6 rounded-lg px-2 py-1 text-sm border border-red-200 text-red-700 hover:bg-red-50"
                                onClick={()=> { if (confirm("¿Eliminar ingrediente?")) removeIngredient(ing.id); }}
                              >
                                Eliminar
                              </button>
                            </div>

                            <div className="mt-3 grid grid-cols-1 md:grid-cols-4 gap-3">
                              <Select
                                label="Categoría"
                                value={ing.category}
                                onChange={(v)=> updateIngredient(ing.id, { category: v })}
                                options={CATS.map(c => ({ key:c.key, label:c.label }))}
                              />
                              <Select
                                label="Unidad"
                                value={ing.unit}
                                onChange={(v)=> {
                                  if (v === "u") {
                                    updateIngredient(ing.id, { unit: v, kcalPerUnit: ing.kcalPerUnit ?? 0 });
                                  } else {
                                    updateIngredient(ing.id, { unit: v, kcalPer100: ing.kcalPer100 ?? 0 });
                                  }
                                }}
                                options={UNITS}
                              />
                              <NumberField
                                label="Porción base"
                                value={ing.portionDefault ?? 0}
                                onChange={(n)=> updateIngredient(ing.id, { portionDefault: n })}
                                min={0} max={5000}
                                suffix={ing.unit}
                              />
                              {isUnit ? (
                                <NumberField
                                  label="kcal por unidad"
                                  value={ing.kcalPerUnit ?? 0}
                                  onChange={(n)=> updateIngredient(ing.id, { kcalPerUnit: n })}
                                  min={0} max={2000}
                                />
                              ) : (
                                <NumberField
                                  label="kcal por 100"
                                  value={ing.kcalPer100 ?? 0}
                                  onChange={(n)=> updateIngredient(ing.id, { kcalPer100: n })}
                                  min={0} max={2000}
                                  suffix={ing.unit === "ml" ? "ml" : "g"}
                                />
                              )}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </Card>
                ) : null}

                {tab === "perfiles" ? (
                  <Card title="Gestión de perfiles" right={<Badge>{profiles.length}</Badge>}>
                    <div className="space-y-3">
                      {profiles.map(p => (
                        <div key={p.id} className="rounded-xl border border-zinc-200 bg-white p-3">
                          <div className="flex items-center justify-between">
                            <div className="font-semibold">{p.name}</div>
                            <div className="flex items-center gap-2">
                              <button
                                className="rounded-lg px-2 py-1 text-sm border border-zinc-200 hover:bg-zinc-50"
                                onClick={()=> setState(s => ({ ...s, activeProfileId: p.id }))}
                              >
                                Activar
                              </button>
                              <button
                                className="rounded-lg px-2 py-1 text-sm border border-red-200 text-red-700 hover:bg-red-50"
                                onClick={()=> { if (confirm("¿Eliminar perfil?")) removeProfile(p.id); }}
                              >
                                Eliminar
                              </button>
                            </div>
                          </div>
                          <div className="mt-2">
                            <TextField label="Nombre" value={p.name} onChange={(v)=> updateProfile(p.id, { name: v })} />
                          </div>
                        </div>
                      ))}
                      <button
                        className="w-full rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                        onClick={addProfile}
                      >
                        + Agregar perfil
                      </button>
                    </div>
                  </Card>
                ) : null}
              </div>
            </main>

            <footer className="max-w-6xl mx-auto px-4 pb-10">
              <div className="text-xs text-zinc-500">
                Guardado local (localStorage). Exportá/Importá JSON para backup o para moverlo entre celular/PC.
              </div>
            </footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
