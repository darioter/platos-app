<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Platos ¬∑ Diario (Local)</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    </style>
  </head>

  <body class="bg-zinc-50 text-zinc-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useState } = React;

      /**********************
       * Utils
       **********************/
      const LS_KEY = "platos_app_v3_dates_weights"; // mantenemos el mismo para NO perder datos
      const uid = () => Math.random().toString(36).slice(2, 10);
      const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
      const round = (n, d=0) => {
        if (!isFinite(n)) return 0;
        const m = Math.pow(10, d);
        return Math.round(n*m)/m;
      };
      function safeJsonParse(s, fallback) {
        try { return JSON.parse(s); } catch { return fallback; }
      }
      function pad2(n){ return String(n).padStart(2,"0"); }
      function todayStr(){
        const d = new Date();
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      }
      function weekdayLabel(dateStr){
        const d = new Date(dateStr + "T00:00:00");
        const days = ["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];
        return days[d.getDay()];
      }
      function monthLabel(ym){
        const [y,m] = ym.split("-");
        const months = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
        const mi = parseInt(m,10)-1;
        return `${months[mi] ?? m} ${y}`;
      }
      function downloadText(filename, text, mime="text/plain") {
        const blob = new Blob([text], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      function toCSV(rows) {
        const esc = (v) => {
          const s = String(v ?? "");
          if (/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
          return s;
        };
        return rows.map(r => r.map(esc).join(",")).join("\n");
      }

      /**********************
       * WHO BMI (adult)
       **********************/
      function bmiCategoryWHO(bmi) {
        if (!isFinite(bmi) || bmi <= 0) return { label: "‚Äî", key: "na" };
        if (bmi < 18.5) return { label: "Bajo peso (<18.5)", key: "under" };
        if (bmi < 25) return { label: "Normopeso (18.5‚Äì24.9)", key: "normal" };
        if (bmi < 30) return { label: "Sobrepeso (25‚Äì29.9)", key: "over" };
        if (bmi < 35) return { label: "Obesidad I (30‚Äì34.9)", key: "ob1" };
        if (bmi < 40) return { label: "Obesidad II (35‚Äì39.9)", key: "ob2" };
        return { label: "Obesidad III (‚â•40)", key: "ob3" };
      }

      /**********************
       * Calorie estimation (practical)
       **********************/
      const ACTIVITY = [
        { key: "sed", label: "Sedentario", factor: 1.2 },
        { key: "light", label: "Ligero (1‚Äì3 d√≠as/sem)", factor: 1.375 },
        { key: "mod", label: "Moderado (3‚Äì5 d√≠as/sem)", factor: 1.55 },
        { key: "high", label: "Alto (6‚Äì7 d√≠as/sem)", factor: 1.725 },
        { key: "ath", label: "Muy alto (doble sesi√≥n)", factor: 1.9 },
      ];
      function bmrMifflin({ sex, weightKg, heightCm, age }) {
        if (!(weightKg>0 && heightCm>0 && age>0)) return 0;
        const s = sex === "f" ? -161 : 5;
        return 10*weightKg + 6.25*heightCm - 5*age + s;
      }
      function goalAdjust(goalKey) {
        if (goalKey === "lose") return -450;
        if (goalKey === "lose_fast") return -650;
        if (goalKey === "gain") return +250;
        return 0;
      }
      function proteinPerKg(goalKey) {
        if (goalKey.startsWith("lose")) return 2.0;
        if (goalKey === "gain") return 1.8;
        return 1.6;
      }

      /**********************
       * Categories / Units
       **********************/
      const CATS = [
        { key: "proteina", label: "Prote√≠na" },
        { key: "vegetal", label: "Vegetal" },
        { key: "fruta", label: "Fruta" },
        { key: "hidrato", label: "Hidrato" },
        { key: "infusion", label: "Infusi√≥n" },
        { key: "extra", label: "Extra" },
      ];
      const UNITS = [
        { key: "g", label: "g" },
        { key: "ml", label: "ml" },
        { key: "u", label: "u" },
      ];

      // 5 columnas simples
      const MEAL_COLS = [
        { key: "desayuno", label: "Desayuno" },
        { key: "almuerzo", label: "Almuerzo" },
        { key: "merienda", label: "Merienda" },
        { key: "cena", label: "Cena" },
        { key: "extras", label: "Extras" },
      ];

      // sugerencias de categor√≠as por columna (no limita, solo filtra por default)
      const DEFAULT_CAT_FILTER = {
        desayuno: ["proteina","fruta","infusion","extra"],
        merienda: ["proteina","fruta","infusion","extra"],
        almuerzo: ["proteina","vegetal","hidrato","extra"],
        cena: ["proteina","vegetal","infusion","extra"],
        extras: ["proteina","vegetal","fruta","hidrato","infusion","extra"],
      };

      /**********************
       * Default ingredients (ampliado)
       **********************/
      function defaultIngredients() {
        return [
          // Prote√≠nas
          { id: uid(), name: "Pollo (pechuga)", category:"proteina", unit:"g", portionDefault:180, kcalPer100:165 },
          { id: uid(), name: "Carne magra", category:"proteina", unit:"g", portionDefault:180, kcalPer100:190 },
          { id: uid(), name: "Pescado", category:"proteina", unit:"g", portionDefault:200, kcalPer100:140 },
          { id: uid(), name: "At√∫n al natural", category:"proteina", unit:"g", portionDefault:120, kcalPer100:110 },
          { id: uid(), name: "Huevo", category:"proteina", unit:"u", portionDefault:2, kcalPerUnit:70 },
          { id: uid(), name: "Claras", category:"proteina", unit:"u", portionDefault:3, kcalPerUnit:17 },
          { id: uid(), name: "Yogur griego natural", category:"proteina", unit:"g", portionDefault:220, kcalPer100:70 },
          { id: uid(), name: "Queso cottage / ricota magra", category:"proteina", unit:"g", portionDefault:150, kcalPer100:90 },
          { id: uid(), name: "Hummus casero", category:"proteina", unit:"g", portionDefault:40, kcalPer100:240 },

          // Vegetales
          { id: uid(), name: "Ensalada mixta", category:"vegetal", unit:"g", portionDefault:300, kcalPer100:25 },
          { id: uid(), name: "Br√≥coli", category:"vegetal", unit:"g", portionDefault:300, kcalPer100:35 },
          { id: uid(), name: "Zapallito", category:"vegetal", unit:"g", portionDefault:300, kcalPer100:20 },
          { id: uid(), name: "Tomate", category:"vegetal", unit:"g", portionDefault:200, kcalPer100:18 },
          { id: uid(), name: "Zanahoria", category:"vegetal", unit:"g", portionDefault:180, kcalPer100:41 },
          { id: uid(), name: "Espinaca", category:"vegetal", unit:"g", portionDefault:150, kcalPer100:23 },

          // Frutas (variadas)
          { id: uid(), name: "Manzana", category:"fruta", unit:"u", portionDefault:1, kcalPerUnit:95 },
          { id: uid(), name: "Banana chica", category:"fruta", unit:"u", portionDefault:1, kcalPerUnit:90 },
          { id: uid(), name: "Naranja", category:"fruta", unit:"u", portionDefault:1, kcalPerUnit:80 },
          { id: uid(), name: "Mandarina", category:"fruta", unit:"u", portionDefault:2, kcalPerUnit:40 },
          { id: uid(), name: "Pera", category:"fruta", unit:"u", portionDefault:1, kcalPerUnit:100 },
          { id: uid(), name: "Kiwi", category:"fruta", unit:"u", portionDefault:1, kcalPerUnit:45 },
          { id: uid(), name: "Uvas", category:"fruta", unit:"g", portionDefault:150, kcalPer100:69 },
          { id: uid(), name: "Frutillas", category:"fruta", unit:"g", portionDefault:160, kcalPer100:32 },
          { id: uid(), name: "Frutos rojos", category:"fruta", unit:"g", portionDefault:120, kcalPer100:50 },

          // Hidratos
          { id: uid(), name: "Arroz cocido", category:"hidrato", unit:"g", portionDefault:160, kcalPer100:130 },
          { id: uid(), name: "Papa al horno", category:"hidrato", unit:"g", portionDefault:200, kcalPer100:110 },
          { id: uid(), name: "Batata al horno", category:"hidrato", unit:"g", portionDefault:200, kcalPer100:90 },
          { id: uid(), name: "Avena", category:"hidrato", unit:"g", portionDefault:60, kcalPer100:389 },
          { id: uid(), name: "Pan integral", category:"hidrato", unit:"g", portionDefault:60, kcalPer100:250 },
          { id: uid(), name: "Dulce de membrillo", category:"hidrato", unit:"g", portionDefault:30, kcalPer100:280 },
          { id: uid(), name: "Bizcochuelo chocolate", category:"hidrato", unit:"g", portionDefault:80, kcalPer100:350 },

          // Infusiones / bebidas
          { id: uid(), name: "Mate", category:"infusion", unit:"ml", portionDefault:300, kcalPer100:0 },
          { id: uid(), name: "Caf√©", category:"infusion", unit:"ml", portionDefault:200, kcalPer100:0 },
          { id: uid(), name: "T√©", category:"infusion", unit:"ml", portionDefault:250, kcalPer100:0 },
          { id: uid(), name: "Agua", category:"infusion", unit:"ml", portionDefault:500, kcalPer100:0 },
          { id: uid(), name: "Leche descremada", category:"infusion", unit:"ml", portionDefault:200, kcalPer100:35 },
          { id: uid(), name: "Leche entera", category:"infusion", unit:"ml", portionDefault:200, kcalPer100:62 },

          // Extras
          { id: uid(), name: "Almendras", category:"extra", unit:"g", portionDefault:15, kcalPer100:580 },
          { id: uid(), name: "Nueces", category:"extra", unit:"g", portionDefault:15, kcalPer100:654 },
          { id: uid(), name: "Mantequilla de man√≠", category:"extra", unit:"g", portionDefault:15, kcalPer100:588 },
          { id: uid(), name: "Aceite de oliva", category:"extra", unit:"g", portionDefault:10, kcalPer100:884 },
          { id: uid(), name: "Chocolate amargo", category:"extra", unit:"g", portionDefault:15, kcalPer100:600 },

          // Alcohol
          { id: uid(), name: "Vino tinto (seco)", category:"extra", unit:"ml", portionDefault:150, kcalPer100:85 },
          { id: uid(), name: "Vino blanco (seco)", category:"extra", unit:"ml", portionDefault:150, kcalPer100:82 },
        ];
      }

      function defaultProfiles() {
        const t = todayStr();
        return [
          {
            id: uid(),
            name: "Dar√≠o",
            sex: "m",
            age: 35,
            heightCm: 178,
            weightKg: 92,
            activityKey: "mod",
            goalKey: "lose",
            weightLog: [{ date: t, weight: 92 }],
          }
        ];
      }

      function makeEmptyPlanDates() {
        const t = todayStr();
        return {
          selectedDate: t,
          dateList: [t],
          selectedForShopping: { [t]: true },
          // entriesByDate: { [date]: { desayuno:[], almuerzo:[], merienda:[], cena:[], extras:[] } }
          entriesByDate: { [t]: makeEmptyDayColumns() },
        };
      }
      function makeEmptyDayColumns() {
        const obj = {};
        for (const c of MEAL_COLS) obj[c.key] = [];
        return obj;
      }

      function defaultState() {
        const prof = defaultProfiles();
        return {
          profiles: prof,
          activeProfileId: prof[0]?.id ?? null,
          ingredients: defaultIngredients(),
          plansByProfileId: {},
        };
      }

      /**********************
       * Portions (LOW/MID/HIGH) + suggestions
       **********************/
      function kcalBand(targetKcal) {
        if (!isFinite(targetKcal) || targetKcal <= 0) return "mid";
        if (targetKcal < 1800) return "low";
        if (targetKcal < 2400) return "mid";
        return "high";
      }

      // multiplicadores por columna y categor√≠a (simple, ajustable)
      const PORTION_MULT = {
        desayuno: { proteina:{low:0.9, mid:1.0, high:1.1}, fruta:{low:0.9, mid:1.0, high:1.15}, infusion:{low:1, mid:1, high:1}, hidrato:{low:0.85, mid:1.0, high:1.1}, vegetal:{low:1, mid:1, high:1}, extra:{low:0.8, mid:1.0, high:1.0} },
        merienda: { proteina:{low:0.9, mid:1.0, high:1.1}, fruta:{low:0.9, mid:1.0, high:1.15}, infusion:{low:1, mid:1, high:1}, hidrato:{low:0.85, mid:1.0, high:1.1}, vegetal:{low:1, mid:1, high:1}, extra:{low:0.8, mid:1.0, high:1.0} },
        almuerzo: { proteina:{low:0.95, mid:1.05, high:1.2}, vegetal:{low:1.0, mid:1.15, high:1.3}, hidrato:{low:0.7, mid:1.0, high:1.25}, infusion:{low:1, mid:1, high:1}, fruta:{low:0.9, mid:1.0, high:1.15}, extra:{low:0.8, mid:1.0, high:1.0} },
        cena: { proteina:{low:0.9, mid:1.0, high:1.1}, vegetal:{low:1.0, mid:1.1, high:1.2}, hidrato:{low:0.6, mid:0.85, high:1.0}, infusion:{low:1, mid:1, high:1}, fruta:{low:0.9, mid:1.0, high:1.15}, extra:{low:0.8, mid:1.0, high:1.0} },
        extras: { proteina:{low:0.85, mid:1.0, high:1.1}, vegetal:{low:1.0, mid:1.0, high:1.1}, hidrato:{low:0.8, mid:1.0, high:1.15}, infusion:{low:1, mid:1, high:1}, fruta:{low:0.9, mid:1.0, high:1.15}, extra:{low:0.8, mid:1.0, high:1.0} },
      };

      function suggestQty({ ing, mealCol, targetKcal }) {
        if (!ing) return 0;
        const band = kcalBand(targetKcal);
        const def = ing.portionDefault ?? 0;
        const cat = ing.category ?? "extra";
        const m = (PORTION_MULT[mealCol]?.[cat]?.[band]) ?? 1.0;
        return round(def * m, 0);
      }

      /**********************
       * Calories
       **********************/
      function kcalForItem(ing, qty) {
        if (!ing) return 0;
        if (ing.unit === "u") return (qty ?? 0) * (ing.kcalPerUnit ?? 0);
        const per100 = ing.kcalPer100 ?? 0;
        return ((qty ?? 0) * per100) / 100;
      }
      function entryTotals(entry, ingById) {
        let kcal = 0;
        for (const it of (entry.items ?? [])) {
          const ing = ingById[it.ingredientId];
          kcal += kcalForItem(ing, it.qty);
        }
        return { kcal: round(kcal, 0) };
      }

      /**********************
       * Weight stats
       **********************/
      function sortWeightLog(log) {
        const arr = Array.isArray(log) ? [...log] : [];
        arr.sort((a,b)=> String(a.date).localeCompare(String(b.date)));
        return arr.filter(x => x?.date && isFinite(x?.weight));
      }
      function upsertWeight(log, entry) {
        const arr = Array.isArray(log) ? [...log] : [];
        const idx = arr.findIndex(x => x.date === entry.date);
        if (idx >= 0) arr[idx] = entry;
        else arr.push(entry);
        return sortWeightLog(arr);
      }
      function monthlyLast(log) {
        const sorted = sortWeightLog(log);
        const byMonth = new Map();
        for (const e of sorted) {
          const ym = e.date.slice(0,7);
          const cur = byMonth.get(ym);
          if (!cur || e.date >= cur.date) byMonth.set(ym, { ...e });
        }
        const months = Array.from(byMonth.entries())
          .map(([ym, v]) => ({ ym, date: v.date, weight: v.weight }))
          .sort((a,b)=> a.ym.localeCompare(b.ym));
        return months;
      }
      function diffMonths(ymA, ymB) {
        const [y1,m1] = ymA.split("-").map(Number);
        const [y2,m2] = ymB.split("-").map(Number);
        return (y2 - y1)*12 + (m2 - m1);
      }
      function computeWeightStats(log) {
        const sorted = sortWeightLog(log);
        if (!sorted.length) return null;

        const initial = sorted[0].weight;
        const current = sorted[sorted.length-1].weight;
        const totalDelta = round(current - initial, 1);

        const months = monthlyLast(sorted);
        const monthlyDeltas = months.map(m => ({
          ...m,
          deltaVsInitial: round(m.weight - initial, 1),
        }));

        let avgPerMonth = 0;
        if (months.length >= 2) {
          const span = Math.max(1, diffMonths(months[0].ym, months[months.length-1].ym));
          avgPerMonth = round((months[months.length-1].weight - months[0].weight) / span, 2);
        }

        let best = null, worst = null;
        for (let i=1;i<months.length;i++){
          const change = round(months[i].weight - months[i-1].weight, 1);
          const obj = { ym: months[i].ym, change };
          if (!best || change < best.change) best = obj;
          if (!worst || change > worst.change) worst = obj;
        }

        const minW = Math.min(...months.map(m=>m.weight), initial);
        const maxW = Math.max(...months.map(m=>m.weight), initial);
        const maxLoss = Math.max(0, initial - minW);
        const maxGain = Math.max(0, maxW - initial);

        return { initial, current, totalDelta, months: monthlyDeltas, avgPerMonth, best, worst, maxLoss, maxGain };
      }

      /**********************
       * Image resize (for localStorage)
       **********************/
      async function fileToResizedDataURL(file, maxSize=900, quality=0.75) {
        const img = await new Promise((res, rej) => {
          const i = new Image();
          i.onload = () => res(i);
          i.onerror = rej;
          i.src = URL.createObjectURL(file);
        });

        const w = img.width, h = img.height;
        const scale = Math.min(1, maxSize / Math.max(w,h));
        const cw = Math.round(w * scale);
        const ch = Math.round(h * scale);

        const canvas = document.createElement("canvas");
        canvas.width = cw;
        canvas.height = ch;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, cw, ch);

        const dataUrl = canvas.toDataURL("image/jpeg", quality);
        URL.revokeObjectURL(img.src);
        return dataUrl;
      }

      /**********************
       * UI Components
       **********************/
      function Badge({ children }) {
        return (
          <span className="inline-flex items-center rounded-full bg-zinc-100 px-2.5 py-1 text-xs font-medium text-zinc-700">
            {children}
          </span>
        );
      }
      function Card({ title, right, children }) {
        return (
          <div className="rounded-2xl bg-white shadow-sm border border-zinc-100">
            <div className="flex items-center justify-between px-4 py-3 border-b border-zinc-100">
              <div className="font-semibold">{title}</div>
              <div>{right}</div>
            </div>
            <div className="p-4">{children}</div>
          </div>
        );
      }
      function TextField({ label, value, onChange, placeholder }) {
        return (
          <label className="block">
            <div className="text-xs font-semibold text-zinc-700 mb-1">{label}</div>
            <input
              className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-200"
              value={value}
              placeholder={placeholder}
              onChange={(e)=> onChange(e.target.value)}
            />
          </label>
        );
      }
      function NumberField({ label, value, onChange, min, max, step=1, suffix }) {
        const [txt, setTxt] = useState(String(value ?? ""));
        useEffect(() => setTxt(String(value ?? "")), [value]);
        return (
          <label className="block">
            <div className="text-xs font-semibold text-zinc-700 mb-1">{label}</div>
            <div className="flex items-center gap-2">
              <input
                className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-200"
                inputMode="decimal"
                value={txt}
                onChange={(e)=> setTxt(e.target.value)}
                onBlur={()=> {
                  const n = parseFloat(String(txt).replace(",", "."));
                  if (!isFinite(n)) { setTxt(String(value ?? "")); return; }
                  const nn = clamp(n, min ?? -1e9, max ?? 1e9);
                  onChange(nn);
                }}
              />
              {suffix ? <span className="text-sm text-zinc-500">{suffix}</span> : null}
            </div>
          </label>
        );
      }
      function Select({ label, value, onChange, options }) {
        return (
          <label className="block">
            {label ? <div className="text-xs font-semibold text-zinc-700 mb-1">{label}</div> : null}
            <select
              className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-200"
              value={value}
              onChange={(e)=> onChange(e.target.value)}
            >
              {options.map(o => (
                <option key={o.key} value={o.key}>{o.label}</option>
              ))}
            </select>
          </label>
        );
      }

      function IconSearch({ className="" }) {
        return (
          <svg className={className} viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" strokeWidth="2" />
            <path d="M16.5 16.5 21 21" stroke="currentColor" strokeWidth="2" strokeLinecap="round" />
          </svg>
        );
      }

      function Modal({ open, title, onClose, children, footer }) {
        if (!open) return null;
        return (
          <div className="fixed inset-0 z-50">
            <div className="absolute inset-0 bg-black/40" onClick={onClose}></div>
            <div className="absolute inset-0 flex items-center justify-center p-4">
              <div className="w-full max-w-2xl rounded-2xl bg-white shadow-xl border border-zinc-200 overflow-hidden">
                <div className="px-4 py-3 border-b border-zinc-100 flex items-center justify-between">
                  <div className="font-semibold">{title}</div>
                  <button
                    className="rounded-lg border border-zinc-200 px-2 py-1 text-sm hover:bg-zinc-50"
                    onClick={onClose}
                  >
                    Cerrar
                  </button>
                </div>
                <div className="p-4 max-h-[70vh] overflow-auto">
                  {children}
                </div>
                {footer ? <div className="px-4 py-3 border-t border-zinc-100">{footer}</div> : null}
              </div>
            </div>
          </div>
        );
      }

      /**********************
       * App
       **********************/
      function App() {
        const [state, setState] = useState(() => {
          const raw = localStorage.getItem(LS_KEY);
          const st = raw ? safeJsonParse(raw, null) : null;

          const base = defaultState();
          if (!st) {
            // init plans
            const init = { ...base, plansByProfileId: {} };
            for (const p of init.profiles) init.plansByProfileId[p.id] = makeEmptyPlanDates();
            return init;
          }

          // Merge
          const migrated = { ...base, ...st };
          if (!migrated.profiles?.length) migrated.profiles = base.profiles;
          if (!migrated.ingredients?.length) migrated.ingredients = base.ingredients;
          if (!migrated.activeProfileId) migrated.activeProfileId = migrated.profiles[0]?.id ?? null;
          if (!migrated.plansByProfileId) migrated.plansByProfileId = {};

          // Ensure weightLog exists
          const t = todayStr();
          migrated.profiles = migrated.profiles.map(p => {
            const wl = sortWeightLog(p.weightLog);
            if (wl.length) return { ...p, weightLog: wl };
            const w = isFinite(p.weightKg) ? p.weightKg : 0;
            return { ...p, weightLog: w>0 ? [{ date: t, weight: w }] : [] };
          });

          // Ensure plan exists per profile
          for (const p of migrated.profiles) {
            if (!migrated.plansByProfileId[p.id]) migrated.plansByProfileId[p.id] = makeEmptyPlanDates();
          }

          // MIGRACI√ìN desde versi√≥n vieja (mealsByDate con "principal")
          // Si existe mealsByDate, lo convertimos a entriesByDate con columnas.
          for (const pid of Object.keys(migrated.plansByProfileId)) {
            const pl = migrated.plansByProfileId[pid];
            if (pl?.entriesByDate) {
              // asegurar columnas por fecha
              const next = { ...pl.entriesByDate };
              for (const ds of Object.keys(next)) {
                next[ds] = { ...makeEmptyDayColumns(), ...(next[ds] || {}) };
              }
              migrated.plansByProfileId[pid] = { ...pl, entriesByDate: next };
              continue;
            }

            if (pl?.mealsByDate) {
              const entriesByDate = {};
              for (const ds of Object.keys(pl.mealsByDate)) {
                const dayCols = makeEmptyDayColumns();
                const meals = pl.mealsByDate[ds] || [];
                for (const m of meals) {
                  // map type -> columna
                  const type = m.type;
                  let col = "extras";
                  if (type === "desayuno") col = "desayuno";
                  else if (type === "merienda") col = "merienda";
                  else if (type === "cena") col = "cena";
                  else if (type === "principal") col = "almuerzo"; // lo que pediste
                  else col = "extras";

                  dayCols[col].push({
                    id: m.id || uid(),
                    mealCol: col,
                    title: "",
                    photoDataUrl: "",
                    source: "manual",
                    items: (m.items || []).map(it => ({ ingredientId: it.ingredientId, qty: it.qty })),
                    notes: "",
                    createdAt: m.createdAt || Date.now(),
                  });
                }
                entriesByDate[ds] = dayCols;
              }

              const cleaned = { ...pl };
              delete cleaned.mealsByDate;
              migrated.plansByProfileId[pid] = { ...cleaned, entriesByDate };
            }
          }

          return migrated;
        });

        useEffect(() => {
          localStorage.setItem(LS_KEY, JSON.stringify(state));
        }, [state]);

        const profiles = state.profiles;
        const activeProfile = profiles.find(p => p.id === state.activeProfileId) ?? profiles[0] ?? null;

        const ingById = useMemo(() => {
          const m = {};
          for (const i of state.ingredients) m[i.id] = i;
          return m;
        }, [state.ingredients]);

        const profileStats = useMemo(() => {
          if (!activeProfile) return null;
          const hM = (activeProfile.heightCm ?? 0) / 100;
          const bmi = hM>0 ? (activeProfile.weightKg / (hM*hM)) : 0;
          const cat = bmiCategoryWHO(bmi);

          const act = ACTIVITY.find(a => a.key === activeProfile.activityKey) ?? ACTIVITY[2];
          const bmr = bmrMifflin({
            sex: activeProfile.sex,
            weightKg: activeProfile.weightKg,
            heightCm: activeProfile.heightCm,
            age: activeProfile.age,
          });
          const tdee = bmr * (act.factor ?? 1.55);
          let target = tdee + goalAdjust(activeProfile.goalKey);
          target = clamp(target, 1400, 3800);

          const protG = round(activeProfile.weightKg * proteinPerKg(activeProfile.goalKey), 0);

          return {
            bmi: round(bmi, 1),
            bmiCat: cat,
            tdee: round(tdee, 0),
            targetKcal: round(target, 0),
            proteinG: protG,
            band: kcalBand(target),
          };
        }, [activeProfile]);

        const weightStats = useMemo(() => {
          if (!activeProfile) return null;
          return computeWeightStats(activeProfile.weightLog);
        }, [activeProfile]);

        const plan = useMemo(() => {
          if (!activeProfile) return null;
          return state.plansByProfileId?.[activeProfile.id] ?? null;
        }, [state.plansByProfileId, activeProfile]);

        const [tab, setTab] = useState("dia");

        /**********************
         * Profiles
         **********************/
        function addProfile() {
          const t = todayStr();
          const p = {
            id: uid(),
            name: "Nuevo perfil",
            sex: "f",
            age: 30,
            heightCm: 165,
            weightKg: 70,
            activityKey: "light",
            goalKey: "lose",
            weightLog: [{ date: t, weight: 70 }],
          };
          setState(s => ({
            ...s,
            profiles: [...s.profiles, p],
            activeProfileId: p.id,
            plansByProfileId: { ...(s.plansByProfileId||{}), [p.id]: makeEmptyPlanDates() }
          }));
        }
        function updateProfile(id, patch) {
          setState(s => ({
            ...s,
            profiles: s.profiles.map(p => p.id === id ? { ...p, ...patch } : p)
          }));
        }
        function removeProfile(id) {
          setState(s => {
            const nextProfiles = s.profiles.filter(p => p.id !== id);
            const nextActive = s.activeProfileId === id ? (nextProfiles[0]?.id ?? null) : s.activeProfileId;
            const nextPlans = { ...(s.plansByProfileId||{}) };
            delete nextPlans[id];
            return { ...s, profiles: nextProfiles, activeProfileId: nextActive, plansByProfileId: nextPlans };
          });
        }

        /**********************
         * Weight log actions
         **********************/
        const [weightDate, setWeightDate] = useState(todayStr());
        const [weightValue, setWeightValue] = useState(activeProfile?.weightKg ?? 0);
        useEffect(() => {
          setWeightDate(todayStr());
          setWeightValue(activeProfile?.weightKg ?? 0);
        }, [activeProfile?.id]);

        function saveWeightEntry() {
          if (!activeProfile) return;
          const d = String(weightDate || "").trim();
          const w = parseFloat(String(weightValue).replace(",", "."));
          if (!/^\d{4}-\d{2}-\d{2}$/.test(d)) return alert("Eleg√≠ una fecha v√°lida.");
          if (!isFinite(w) || w <= 0) return alert("Ingres√° un peso v√°lido.");

          setState(s => {
            const nextProfiles = s.profiles.map(p => {
              if (p.id !== activeProfile.id) return p;
              const wl = upsertWeight(p.weightLog, { date: d, weight: round(w, 1) });
              const latest = wl[wl.length-1]?.weight ?? p.weightKg;
              return { ...p, weightLog: wl, weightKg: latest };
            });
            return { ...s, profiles: nextProfiles };
          });
        }

        function deleteWeightEntry(dateStr) {
          if (!activeProfile) return;
          if (!confirm("¬øEliminar este registro de peso?")) return;
          setState(s => {
            const nextProfiles = s.profiles.map(p => {
              if (p.id !== activeProfile.id) return p;
              const wl = sortWeightLog(p.weightLog).filter(e => e.date !== dateStr);
              const latest = wl.length ? wl[wl.length-1].weight : p.weightKg;
              return { ...p, weightLog: wl, weightKg: latest };
            });
            return { ...s, profiles: nextProfiles };
          });
        }

        /**********************
         * Ingredients
         **********************/
        function addIngredient(ing) {
          setState(s => ({ ...s, ingredients: [...s.ingredients, ing] }));
        }
        function updateIngredient(id, patch) {
          setState(s => ({
            ...s,
            ingredients: s.ingredients.map(i => i.id === id ? { ...i, ...patch } : i)
          }));
        }
        function removeIngredient(id) {
          setState(s => {
            const nextIngredients = s.ingredients.filter(i => i.id !== id);
            const nextPlans = { ...(s.plansByProfileId||{}) };

            // limpiar de entradas
            for (const pid of Object.keys(nextPlans)) {
              const pl = nextPlans[pid];
              if (!pl?.entriesByDate) continue;
              const entriesByDate = { ...pl.entriesByDate };
              for (const ds of Object.keys(entriesByDate)) {
                const cols = { ...entriesByDate[ds] };
                for (const colKey of Object.keys(cols)) {
                  cols[colKey] = (cols[colKey] || []).map(en => ({
                    ...en,
                    items: (en.items || []).filter(it => it.ingredientId !== id)
                  }));
                }
                entriesByDate[ds] = cols;
              }
              nextPlans[pid] = { ...pl, entriesByDate };
            }

            return { ...s, ingredients: nextIngredients, plansByProfileId: nextPlans };
          });
        }

        /**********************
         * Dates + Day entries
         **********************/
        const selectedDate = plan?.selectedDate ?? todayStr();
        const dateList = plan?.dateList ?? [todayStr()];
        const entriesToday = plan?.entriesByDate?.[selectedDate] ?? makeEmptyDayColumns();

        function setSelectedDate(ds) {
          if (!activeProfile) return;
          setState(s => {
            const pl = s.plansByProfileId?.[activeProfile.id] ?? makeEmptyPlanDates();
            const entriesByDate = { ...(pl.entriesByDate ?? {}) };
            if (!entriesByDate[ds]) entriesByDate[ds] = makeEmptyDayColumns();
            else entriesByDate[ds] = { ...makeEmptyDayColumns(), ...(entriesByDate[ds]||{}) };

            const dateList2 = pl.dateList?.includes(ds) ? pl.dateList : [ds, ...(pl.dateList ?? [])];
            const selShop = { ...(pl.selectedForShopping ?? {}) };
            if (selShop[ds] === undefined) selShop[ds] = true;

            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [activeProfile.id]: { ...pl, selectedDate: ds, dateList: dateList2, entriesByDate, selectedForShopping: selShop }
              }
            };
          });
        }
        function addDateToList(ds) {
          if (!activeProfile) return;
          setState(s => {
            const pl = s.plansByProfileId?.[activeProfile.id] ?? makeEmptyPlanDates();
            const dateList2 = pl.dateList?.includes(ds) ? pl.dateList : [ds, ...(pl.dateList ?? [])];
            const entriesByDate = { ...(pl.entriesByDate ?? {}) };
            if (!entriesByDate[ds]) entriesByDate[ds] = makeEmptyDayColumns();
            else entriesByDate[ds] = { ...makeEmptyDayColumns(), ...(entriesByDate[ds]||{}) };
            const selShop = { ...(pl.selectedForShopping ?? {}) };
            if (selShop[ds] === undefined) selShop[ds] = true;
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [activeProfile.id]: { ...pl, dateList: dateList2, entriesByDate, selectedForShopping: selShop }
              }
            };
          });
        }
        function toggleShopDate(ds) {
          if (!activeProfile) return;
          setState(s => {
            const pl = s.plansByProfileId?.[activeProfile.id] ?? makeEmptyPlanDates();
            const sel = { ...(pl.selectedForShopping ?? {}) };
            sel[ds] = !sel[ds];
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [activeProfile.id]: { ...pl, selectedForShopping: sel }
              }
            };
          });
        }
        function selectOnlyTodayForShopping() {
          if (!activeProfile) return;
          setState(s => {
            const pl = s.plansByProfileId?.[activeProfile.id] ?? makeEmptyPlanDates();
            const sel = {};
            for (const ds of (pl.dateList ?? [])) sel[ds] = false;
            sel[pl.selectedDate] = true;
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [activeProfile.id]: { ...pl, selectedForShopping: sel }
              }
            };
          });
        }
        function selectAllForShopping(v=true) {
          if (!activeProfile) return;
          setState(s => {
            const pl = s.plansByProfileId?.[activeProfile.id] ?? makeEmptyPlanDates();
            const sel = { ...(pl.selectedForShopping ?? {}) };
            for (const ds of (pl.dateList ?? [])) sel[ds] = v;
            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [activeProfile.id]: { ...pl, selectedForShopping: sel }
              }
            };
          });
        }

        /**********************
         * Add/Edit Entry Modal
         **********************/
        const targetKcal = profileStats?.targetKcal ?? 2100;

        const [entryModalOpen, setEntryModalOpen] = useState(false);
        const [entryModalCol, setEntryModalCol] = useState("desayuno");
        const [editingEntryId, setEditingEntryId] = useState(null);

        const emptyDraft = () => ({
          id: uid(),
          mealCol: entryModalCol,
          title: "",
          photoDataUrl: "",
          source: "manual", // manual | foto
          notes: "",
          items: [], // { ingredientId, qty }
          createdAt: Date.now(),
        });

        const [draft, setDraft] = useState(emptyDraft());
        const [ingSearch, setIngSearch] = useState("");
        const [catFilter, setCatFilter] = useState(DEFAULT_CAT_FILTER[entryModalCol] || DEFAULT_CAT_FILTER.extras);

        function openAddEntry(colKey) {
          setEntryModalCol(colKey);
          setEditingEntryId(null);
          setIngSearch("");
          setCatFilter(DEFAULT_CAT_FILTER[colKey] || DEFAULT_CAT_FILTER.extras);
          setDraft({
            id: uid(),
            mealCol: colKey,
            title: "",
            photoDataUrl: "",
            source: "manual",
            notes: "",
            items: [],
            createdAt: Date.now(),
          });
          setEntryModalOpen(true);
        }

        function openEditEntry(colKey, entry) {
          setEntryModalCol(colKey);
          setEditingEntryId(entry.id);
          setIngSearch("");
          setCatFilter(DEFAULT_CAT_FILTER[colKey] || DEFAULT_CAT_FILTER.extras);
          setDraft({
            id: entry.id,
            mealCol: colKey,
            title: entry.title || "",
            photoDataUrl: entry.photoDataUrl || "",
            source: entry.source || (entry.photoDataUrl ? "foto" : "manual"),
            notes: entry.notes || "",
            items: (entry.items || []).map(it => ({ ingredientId: it.ingredientId, qty: it.qty })),
            createdAt: entry.createdAt || Date.now(),
          });
          setEntryModalOpen(true);
        }

        function closeEntryModal() {
          setEntryModalOpen(false);
          setEditingEntryId(null);
        }

        async function handlePhotoUpload(file) {
          if (!file) return;
          try {
            const dataUrl = await fileToResizedDataURL(file, 900, 0.75);
            setDraft(d => ({ ...d, photoDataUrl: dataUrl, source: "foto" }));
          } catch (e) {
            alert("No se pudo procesar la foto.");
          }
        }

        function addDraftItem(ingredientId) {
          if (!ingredientId) return;
          const exists = draft.items.some(it => it.ingredientId === ingredientId);
          if (exists) return;

          const ing = ingById[ingredientId];
          const suggested = suggestQty({ ing, mealCol: entryModalCol, targetKcal });

          setDraft(d => ({
            ...d,
            items: [...d.items, { ingredientId, qty: suggested }]
          }));
        }

        function updateDraftQty(ingredientId, qty) {
          setDraft(d => ({
            ...d,
            items: d.items.map(it => it.ingredientId === ingredientId ? { ...it, qty } : it)
          }));
        }

        function removeDraftItem(ingredientId) {
          setDraft(d => ({ ...d, items: d.items.filter(it => it.ingredientId !== ingredientId) }));
        }

        function saveDraftToDay() {
          if (!activeProfile) return;
          // permitir entrada solo con foto (sin items) si quiere
          if (!draft.photoDataUrl && (!draft.items || !draft.items.length) && !draft.title.trim()) {
            return alert("Sum√° al menos una foto, un ingrediente o un t√≠tulo.");
          }

          setState(s => {
            const pid = activeProfile.id;
            const pl = s.plansByProfileId?.[pid] ?? makeEmptyPlanDates();
            const ds = pl.selectedDate ?? todayStr();
            const entriesByDate = { ...(pl.entriesByDate ?? {}) };
            const day = { ...makeEmptyDayColumns(), ...(entriesByDate[ds] || {}) };

            const colArr = [...(day[entryModalCol] || [])];

            const entryObj = {
              id: draft.id,
              mealCol: entryModalCol,
              title: draft.title || "",
              photoDataUrl: draft.photoDataUrl || "",
              source: draft.source || "manual",
              notes: draft.notes || "",
              items: (draft.items || []).filter(it => it.ingredientId && it.qty > 0),
              createdAt: draft.createdAt || Date.now(),
            };

            const idx = colArr.findIndex(x => x.id === (editingEntryId || draft.id));
            if (idx >= 0) colArr[idx] = entryObj;
            else colArr.unshift(entryObj);

            day[entryModalCol] = colArr;
            entriesByDate[ds] = day;

            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [pid]: { ...pl, entriesByDate }
              }
            };
          });

          closeEntryModal();
        }

        function deleteEntry(colKey, entryId) {
          if (!activeProfile) return;
          if (!confirm("¬øEliminar este registro?")) return;
          setState(s => {
            const pid = activeProfile.id;
            const pl = s.plansByProfileId?.[pid] ?? makeEmptyPlanDates();
            const ds = pl.selectedDate ?? todayStr();
            const entriesByDate = { ...(pl.entriesByDate ?? {}) };
            const day = { ...makeEmptyDayColumns(), ...(entriesByDate[ds] || {}) };
            day[colKey] = (day[colKey] || []).filter(en => en.id !== entryId);
            entriesByDate[ds] = day;

            return {
              ...s,
              plansByProfileId: {
                ...(s.plansByProfileId||{}),
                [pid]: { ...pl, entriesByDate }
              }
            };
          });
        }

        const dayKcal = useMemo(() => {
          let sum = 0;
          for (const col of MEAL_COLS) {
            const arr = entriesToday?.[col.key] || [];
            for (const en of arr) sum += entryTotals(en, ingById).kcal;
          }
          return round(sum, 0);
        }, [entriesToday, ingById]);

        /**********************
         * Shopping list
         **********************/
        const shopping = useMemo(() => {
          if (!plan) return [];
          const sel = plan.selectedForShopping ?? {};
          const map = new Map();

          for (const ds of (plan.dateList ?? [])) {
            if (!sel[ds]) continue;
            const day = plan.entriesByDate?.[ds] ?? null;
            if (!day) continue;

            for (const col of MEAL_COLS) {
              const arr = day[col.key] || [];
              for (const en of arr) {
                for (const it of (en.items ?? [])) {
                  map.set(it.ingredientId, (map.get(it.ingredientId) ?? 0) + (it.qty ?? 0));
                }
              }
            }
          }

          const rows = [];
          for (const [ingId, qty] of map.entries()) {
            const ing = ingById[ingId];
            if (!ing) continue;
            rows.push({
              category: ing.category,
              ingredient: ing.name,
              qty: round(qty, 0),
              unit: ing.unit,
            });
          }
          rows.sort((a,b)=> (a.category+a.ingredient).localeCompare(b.category+b.ingredient));
          return rows;
        }, [plan, ingById]);

        function exportShoppingCSV() {
          const header = [["categoria","ingrediente","cantidad","unidad"]];
          const data = shopping.map(r => [r.category, r.ingredient, r.qty, r.unit]);
          downloadText("lista_compras.csv", toCSV([...header, ...data]), "text/csv");
        }

        function exportJSON() {
          downloadText("platos_app_backup.json", JSON.stringify(state, null, 2), "application/json");
        }
        function importJSON(file) {
          const reader = new FileReader();
          reader.onload = () => {
            const obj = safeJsonParse(reader.result, null);
            if (!obj || typeof obj !== "object") return alert("JSON inv√°lido.");
            if (!Array.isArray(obj.profiles) || !Array.isArray(obj.ingredients)) {
              return alert("El JSON no parece ser un backup de esta app.");
            }
            setState({
              profiles: obj.profiles,
              activeProfileId: obj.activeProfileId ?? obj.profiles?.[0]?.id ?? null,
              ingredients: obj.ingredients,
              plansByProfileId: obj.plansByProfileId ?? {},
            });
          };
          reader.readAsText(file);
        }

        /**********************
         * Ingredients UI (collapse + modal add + search)
         **********************/
        const [ingredientSearch, setIngredientSearch] = useState("");
        const [expandedIngredientIds, setExpandedIngredientIds] = useState(() => ({}));

        function toggleExpandedIng(id) {
          setExpandedIngredientIds(m => ({ ...m, [id]: !m[id] }));
        }

        const filteredIngredients = useMemo(() => {
          const q = ingredientSearch.trim().toLowerCase();
          if (!q) return state.ingredients;
          return state.ingredients.filter(i => (i.name || "").toLowerCase().includes(q));
        }, [state.ingredients, ingredientSearch]);

        // Add Ingredient Modal
        const [addIngOpen, setAddIngOpen] = useState(false);
        const [newIng, setNewIng] = useState({
          id: uid(),
          name: "",
          category: "proteina",
          unit: "g",
          portionDefault: 100,
          kcalPer100: 100,
          kcalPerUnit: 0,
        });

        function openAddIngredientModal() {
          setNewIng({
            id: uid(),
            name: "Nuevo ingrediente",
            category: "proteina",
            unit: "g",
            portionDefault: 100,
            kcalPer100: 100,
            kcalPerUnit: 0,
          });
          setAddIngOpen(true);
        }
        function saveNewIngredient() {
          if (!newIng.name.trim()) return alert("Pon√© un nombre.");
          const ing = { ...newIng };
          // limpiar campos seg√∫n unidad
          if (ing.unit === "u") {
            ing.kcalPerUnit = isFinite(ing.kcalPerUnit) ? ing.kcalPerUnit : 0;
            delete ing.kcalPer100;
          } else {
            ing.kcalPer100 = isFinite(ing.kcalPer100) ? ing.kcalPer100 : 0;
            delete ing.kcalPerUnit;
          }
          addIngredient(ing);
          setAddIngOpen(false);
        }

        /**********************
         * Day columns rendering
         **********************/
        function EntryCard({ colKey, entry }) {
          const tot = entryTotals(entry, ingById);
          const hasPhoto = !!entry.photoDataUrl;

          return (
            <div className="rounded-xl border border-zinc-200 bg-white p-3">
              <div className="flex items-start justify-between gap-2">
                <div>
                  <div className="font-semibold text-sm">
                    {entry.title?.trim() ? entry.title : "Registro"}
                  </div>
                  <div className="text-xs text-zinc-500">
                    {entry.source === "foto" ? "üì∑ Foto" : "‚úçÔ∏è Manual"} ¬∑ <span className="mono">{tot.kcal}</span> kcal
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button
                    className="rounded-lg px-2 py-1 text-xs border border-zinc-200 hover:bg-zinc-50"
                    onClick={()=> openEditEntry(colKey, entry)}
                  >
                    Editar
                  </button>
                  <button
                    className="rounded-lg px-2 py-1 text-xs border border-red-200 text-red-700 hover:bg-red-50"
                    onClick={()=> deleteEntry(colKey, entry.id)}
                  >
                    Borrar
                  </button>
                </div>
              </div>

              {hasPhoto ? (
                <div className="mt-2">
                  <img src={entry.photoDataUrl} alt="foto" className="w-full rounded-lg border border-zinc-200" />
                </div>
              ) : null}

              {(entry.items?.length ?? 0) > 0 ? (
                <div className="mt-2 text-sm text-zinc-700 space-y-1">
                  {entry.items.map((it, i) => {
                    const ing = ingById[it.ingredientId];
                    return (
                      <div key={i} className="flex items-center justify-between border-b last:border-b-0 border-zinc-100 py-1">
                        <div className="text-sm">{ing?.name ?? "?"}</div>
                        <div className="mono text-xs text-zinc-600">
                          {round(it.qty,0)} {ing?.unit ?? ""} ¬∑ {round(kcalForItem(ing, it.qty),0)} kcal
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : null}

              {entry.notes?.trim() ? (
                <div className="mt-2 text-xs text-zinc-600">
                  <span className="font-semibold">Notas:</span> {entry.notes}
                </div>
              ) : null}
            </div>
          );
        }

        /**********************
         * Draft ingredient list (search + default categories)
         **********************/
        const ingredientListForDraft = useMemo(() => {
          const q = ingSearch.trim().toLowerCase();
          const allowedCats = new Set(catFilter || []);
          return state.ingredients
            .filter(i => allowedCats.has(i.category))
            .filter(i => !q || (i.name || "").toLowerCase().includes(q))
            .sort((a,b)=> (a.name || "").localeCompare(b.name || ""));
        }, [state.ingredients, ingSearch, catFilter]);

        const draftTotals = useMemo(() => entryTotals(draft, ingById), [draft, ingById]);

        /**********************
         * Render
         **********************/
        return (
          <div className="min-h-screen">
            <header className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-zinc-100">
              <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
                <div className="font-bold tracking-tight">Platos ¬∑ Diario</div>
                <Badge>localStorage</Badge>

                <div className="ml-auto flex items-center gap-2">
                  <select
                    className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm"
                    value={state.activeProfileId ?? ""}
                    onChange={(e)=> setState(s => ({ ...s, activeProfileId: e.target.value }))}
                  >
                    {profiles.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>
                  <button
                    className="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                    onClick={addProfile}
                  >
                    + Perfil
                  </button>
                </div>
              </div>

              <div className="max-w-6xl mx-auto px-4 pb-3 flex flex-wrap gap-2">
                {[
                  { key:"dia", label:"D√≠a" },
                  { key:"compras", label:"Compras" },
                  { key:"ingredientes", label:"Ingredientes" },
                  { key:"perfiles", label:"Perfiles" },
                ].map(t => (
                  <button
                    key={t.key}
                    onClick={()=> setTab(t.key)}
                    className={[
                      "px-3 py-1.5 rounded-full text-sm border",
                      tab===t.key ? "bg-zinc-900 text-white border-zinc-900" : "bg-white border-zinc-200 hover:bg-zinc-50"
                    ].join(" ")}
                  >
                    {t.label}
                  </button>
                ))}

                <div className="ml-auto flex items-center gap-2">
                  <button className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50" onClick={exportJSON}>
                    Exportar JSON
                  </button>
                  <label className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50 cursor-pointer">
                    Importar JSON
                    <input type="file" accept="application/json" className="hidden" onChange={(e)=> {
                      const f = e.target.files?.[0];
                      if (f) importJSON(f);
                      e.target.value = "";
                    }} />
                  </label>
                </div>
              </div>
            </header>

            <main className="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
              {/* LEFT */}
              <div className="lg:col-span-1 space-y-4">
                <Card title="Perfil activo" right={<Badge>{activeProfile?.name ?? "‚Äî"}</Badge>}>
                  {!activeProfile ? (
                    <div className="text-sm text-zinc-600">Cre√° un perfil para empezar.</div>
                  ) : (
                    <div className="space-y-3">
                      <div className="grid grid-cols-2 gap-3">
                        <Select
                          label="Sexo"
                          value={activeProfile.sex}
                          onChange={(v)=> updateProfile(activeProfile.id, { sex: v })}
                          options={[{ key:"m", label:"Masculino" },{ key:"f", label:"Femenino" }]}
                        />
                        <NumberField label="Edad" value={activeProfile.age} onChange={(n)=> updateProfile(activeProfile.id, { age: n })} min={14} max={90} suffix="a√±os" />
                        <NumberField label="Altura" value={activeProfile.heightCm} onChange={(n)=> updateProfile(activeProfile.id, { heightCm: n })} min={120} max={220} suffix="cm" />
                        <NumberField label="Peso (auto desde log)" value={activeProfile.weightKg} onChange={(n)=> updateProfile(activeProfile.id, { weightKg: n })} min={35} max={250} step={0.1} suffix="kg" />
                        <Select
                          label="Actividad"
                          value={activeProfile.activityKey}
                          onChange={(v)=> updateProfile(activeProfile.id, { activityKey: v })}
                          options={ACTIVITY.map(a => ({ key:a.key, label:`${a.label} (√ó${a.factor})` }))}
                        />
                        <Select
                          label="Objetivo"
                          value={activeProfile.goalKey}
                          onChange={(v)=> updateProfile(activeProfile.id, { goalKey: v })}
                          options={[
                            { key:"lose", label:"Bajar (moderado)" },
                            { key:"lose_fast", label:"Bajar (agresivo)" },
                            { key:"maintain", label:"Mantener" },
                            { key:"gain", label:"Subir (lean)" },
                          ]}
                        />
                      </div>

                      {profileStats ? (
                        <div className="rounded-xl bg-zinc-50 border border-zinc-200 p-3 space-y-2">
                          <div className="flex items-center justify-between">
                            <div className="text-sm font-semibold">IMC</div>
                            <div className="mono text-sm">{profileStats.bmi}</div>
                          </div>
                          <div className="text-sm text-zinc-700">{profileStats.bmiCat.label}</div>

                          <div className="grid grid-cols-2 gap-2 pt-2">
                            <div className="rounded-lg bg-white border border-zinc-200 p-2">
                              <div className="text-xs text-zinc-500">TDEE</div>
                              <div className="mono text-sm font-semibold">{profileStats.tdee} kcal</div>
                            </div>
                            <div className="rounded-lg bg-white border border-zinc-200 p-2">
                              <div className="text-xs text-zinc-500">Objetivo</div>
                              <div className="mono text-sm font-semibold">{profileStats.targetKcal} kcal</div>
                            </div>
                            <div className="rounded-lg bg-white border border-zinc-200 p-2 col-span-2">
                              <div className="text-xs text-zinc-500">Prote√≠na sugerida</div>
                              <div className="mono text-sm font-semibold">{profileStats.proteinG} g/d√≠a</div>
                              <div className="text-xs text-zinc-500 mt-1">
                                Escenario porciones: <span className="mono font-semibold">{profileStats.band.toUpperCase()}</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      ) : null}

                      {/* Weight report */}
                      <div className="rounded-xl bg-white border border-zinc-200 p-3 space-y-3">
                        <div className="flex items-center justify-between">
                          <div className="font-semibold">Reporte de peso</div>
                          <Badge>mensual</Badge>
                        </div>

                        <div className="grid grid-cols-2 gap-2">
                          <label className="block">
                            <div className="text-xs font-semibold text-zinc-700 mb-1">Fecha</div>
                            <input
                              type="date"
                              className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm"
                              value={weightDate}
                              onChange={(e)=> setWeightDate(e.target.value)}
                            />
                          </label>
                          <NumberField
                            label="Peso"
                            value={weightValue}
                            onChange={(n)=> setWeightValue(n)}
                            min={30} max={300}
                            step={0.1}
                            suffix="kg"
                          />
                        </div>

                        <button
                          className="w-full rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                          onClick={saveWeightEntry}
                        >
                          Guardar registro
                        </button>

                        {weightStats ? (
                          <div className="rounded-xl bg-zinc-50 border border-zinc-200 p-3 space-y-2">
                            <div className="grid grid-cols-2 gap-2">
                              <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                <div className="text-xs text-zinc-500">Inicial</div>
                                <div className="mono font-semibold">{round(weightStats.initial,1)} kg</div>
                              </div>
                              <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                <div className="text-xs text-zinc-500">Actual</div>
                                <div className="mono font-semibold">{round(weightStats.current,1)} kg</div>
                              </div>
                              <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                <div className="text-xs text-zinc-500">Variaci√≥n total</div>
                                <div className={"mono font-semibold " + (weightStats.totalDelta <= 0 ? "text-emerald-700" : "text-red-700")}>
                                  {weightStats.totalDelta > 0 ? "+" : ""}{weightStats.totalDelta} kg
                                </div>
                              </div>
                              <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                <div className="text-xs text-zinc-500">Promedio</div>
                                <div className="mono font-semibold">{weightStats.avgPerMonth} kg/mes</div>
                              </div>
                            </div>

                            <div className="pt-2">
                              <div className="text-xs font-semibold text-zinc-700 mb-2">Evoluci√≥n por mes (vs inicial)</div>
                              <div className="space-y-2">
                                {weightStats.months.map(m => {
                                  const delta = m.deltaVsInitial;
                                  const isDown = delta <= 0;
                                  const mag = Math.abs(delta);
                                  const denom = isDown ? (weightStats.maxLoss || 1) : (weightStats.maxGain || 1);
                                  const pct = clamp((mag / denom) * 100, 0, 100);

                                  return (
                                    <div key={m.ym} className="grid grid-cols-12 gap-2 items-center">
                                      <div className="col-span-4 text-xs text-zinc-600">{monthLabel(m.ym)}</div>
                                      <div className="col-span-6">
                                        <div className="h-3 rounded-full bg-white border border-zinc-200 overflow-hidden">
                                          <div className={"h-full " + (isDown ? "bg-emerald-500" : "bg-red-500")} style={{ width: pct + "%" }} />
                                        </div>
                                      </div>
                                      <div className="col-span-2 mono text-xs text-right">{delta > 0 ? "+" : ""}{delta} kg</div>
                                    </div>
                                  );
                                })}
                              </div>

                              {(weightStats.best || weightStats.worst) ? (
                                <div className="mt-3 grid grid-cols-2 gap-2">
                                  <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                    <div className="text-xs text-zinc-500">Mejor mes</div>
                                    <div className="text-sm font-semibold">
                                      {weightStats.best ? `${monthLabel(weightStats.best.ym)} (${weightStats.best.change} kg)` : "‚Äî"}
                                    </div>
                                  </div>
                                  <div className="rounded-lg bg-white border border-zinc-200 p-2">
                                    <div className="text-xs text-zinc-500">Peor mes</div>
                                    <div className="text-sm font-semibold">
                                      {weightStats.worst ? `${monthLabel(weightStats.worst.ym)} (+${weightStats.worst.change} kg)` : "‚Äî"}
                                    </div>
                                  </div>
                                </div>
                              ) : null}
                            </div>

                            <div className="pt-3">
                              <div className="text-xs font-semibold text-zinc-700 mb-2">Registros (√∫ltimos 10)</div>
                              <div className="space-y-1">
                                {sortWeightLog(activeProfile.weightLog).slice(-10).reverse().map(e => (
                                  <div key={e.date} className="flex items-center justify-between rounded-lg bg-white border border-zinc-200 px-2 py-1">
                                    <div className="text-xs text-zinc-600">{e.date}</div>
                                    <div className="flex items-center gap-2">
                                      <div className="mono text-xs font-semibold">{round(e.weight,1)} kg</div>
                                      <button
                                        className="text-xs text-red-700 border border-red-200 rounded-md px-2 py-0.5 hover:bg-red-50"
                                        onClick={()=> deleteWeightEntry(e.date)}
                                      >
                                        borrar
                                      </button>
                                    </div>
                                  </div>
                                ))}
                              </div>
                              <div className="text-xs text-zinc-500 mt-2">
                                Tip: si carg√°s la misma fecha, se reemplaza (sirve para ‚Äúpeso oficial del d√≠a‚Äù).
                              </div>
                            </div>
                          </div>
                        ) : (
                          <div className="text-sm text-zinc-600">
                            Carg√° al menos 1 registro para ver el reporte.
                          </div>
                        )}
                      </div>

                      <button
                        className="w-full rounded-xl border border-red-200 bg-white px-3 py-2 text-sm text-red-700 hover:bg-red-50"
                        onClick={()=> { if (confirm("¬øEliminar este perfil?")) removeProfile(activeProfile.id); }}
                      >
                        Eliminar perfil
                      </button>
                    </div>
                  )}
                </Card>

                {activeProfile && tab === "dia" ? (
                  <Card title="Calendario" right={<Badge>{selectedDate}</Badge>}>
                    <div className="grid grid-cols-1 gap-3">
                      <div className="flex items-end gap-2">
                        <label className="block flex-1">
                          <div className="text-xs font-semibold text-zinc-700 mb-1">Elegir fecha</div>
                          <input
                            type="date"
                            className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm"
                            value={selectedDate}
                            onChange={(e)=> setSelectedDate(e.target.value)}
                          />
                        </label>
                        <button
                          className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50"
                          onClick={()=> setSelectedDate(todayStr())}
                        >
                          Hoy
                        </button>
                        <button
                          className="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                          onClick={()=> addDateToList(selectedDate)}
                        >
                          + Guardar
                        </button>
                      </div>

                      <div className="text-xs text-zinc-500">
                        Guard√° varios d√≠as y tild√° cu√°les sumar para la compra.
                      </div>

                      <div className="flex flex-wrap gap-2">
                        {(dateList ?? []).map(ds => (
                          <button
                            key={ds}
                            onClick={()=> setSelectedDate(ds)}
                            className={[
                              "px-3 py-1.5 rounded-full text-sm border",
                              ds===selectedDate ? "bg-zinc-900 text-white border-zinc-900" : "bg-white border-zinc-200 hover:bg-zinc-50"
                            ].join(" ")}
                          >
                            {weekdayLabel(ds)} {ds}
                          </button>
                        ))}
                      </div>

                      <div className="flex items-center justify-between">
                        <div className="text-sm text-zinc-600">Total kcal (fecha)</div>
                        <div className="mono text-lg font-semibold">{dayKcal}</div>
                      </div>
                      {profileStats ? (
                        <div className="text-sm text-zinc-600">
                          Objetivo: <span className="mono font-semibold">{profileStats.targetKcal}</span> kcal
                          {" ¬∑ "}
                          Dif:{" "}
                          <span className={"mono font-semibold " + (dayKcal > profileStats.targetKcal ? "text-red-600" : "text-emerald-600")}>
                            {dayKcal - profileStats.targetKcal}
                          </span>
                        </div>
                      ) : null}
                    </div>
                  </Card>
                ) : null}
              </div>

              {/* RIGHT */}
              <div className="lg:col-span-2 space-y-4">
                {tab === "dia" && activeProfile ? (
                  <Card
                    title={`D√≠a ¬∑ ${weekdayLabel(selectedDate)} ${selectedDate}`}
                    right={<Badge>5 columnas</Badge>}
                  >
                    <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                      {MEAL_COLS.map(col => {
                        const arr = entriesToday?.[col.key] || [];
                        const colKcal = arr.reduce((s,en)=> s + entryTotals(en, ingById).kcal, 0);

                        return (
                          <div key={col.key} className="rounded-2xl border border-zinc-200 bg-zinc-50 p-3 flex flex-col gap-2 min-h-[420px]">
                            <div className="flex items-start justify-between gap-2">
                              <div>
                                <div className="font-semibold">{col.label}</div>
                                <div className="text-xs text-zinc-500">
                                  <span className="mono">{round(colKcal,0)}</span> kcal
                                </div>
                              </div>
                              <button
                                className="rounded-xl bg-zinc-900 text-white px-3 py-1.5 text-sm hover:bg-zinc-800"
                                onClick={()=> openAddEntry(col.key)}
                              >
                                + Agregar
                              </button>
                            </div>

                            {arr.length === 0 ? (
                              <div className="text-xs text-zinc-500 mt-2">
                                Sin registros todav√≠a.
                              </div>
                            ) : (
                              <div className="space-y-2">
                                {arr.map(en => (
                                  <EntryCard key={en.id} colKey={col.key} entry={en} />
                                ))}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </Card>
                ) : null}

                {tab === "compras" && activeProfile ? (
                  <Card
                    title="Lista de compras (sumando fechas seleccionadas)"
                    right={
                      <div className="flex items-center gap-2">
                        <button className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50" onClick={()=> selectAllForShopping(true)}>
                          Seleccionar todo
                        </button>
                        <button className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50" onClick={selectOnlyTodayForShopping}>
                          Solo hoy
                        </button>
                        <button
                          className="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                          onClick={exportShoppingCSV}
                        >
                          Descargar CSV
                        </button>
                      </div>
                    }
                  >
                    <div className="mb-3">
                      <div className="text-sm font-semibold mb-2">Fechas incluidas en la compra</div>
                      <div className="flex flex-wrap gap-2">
                        {(dateList ?? []).map(ds => (
                          <label key={ds} className="flex items-center gap-2 rounded-full border border-zinc-200 bg-white px-3 py-1.5 text-sm cursor-pointer">
                            <input type="checkbox" checked={!!(plan?.selectedForShopping?.[ds])} onChange={()=> toggleShopDate(ds)} />
                            <span>{weekdayLabel(ds)} {ds}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    {shopping.length === 0 ? (
                      <div className="text-sm text-zinc-600">
                        No hay comidas cargadas en las fechas seleccionadas. Carg√° registros y/o tild√° fechas.
                      </div>
                    ) : (
                      <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="text-left text-zinc-500">
                              <th className="py-2">Categor√≠a</th>
                              <th>Ingrediente</th>
                              <th className="text-right">Cantidad</th>
                              <th className="text-right">Unidad</th>
                            </tr>
                          </thead>
                          <tbody>
                            {shopping.map((r, i) => (
                              <tr key={i} className="border-t border-zinc-100">
                                <td className="py-2">{r.category}</td>
                                <td>{r.ingredient}</td>
                                <td className="text-right mono">{r.qty}</td>
                                <td className="text-right">{r.unit}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </Card>
                ) : null}

                {tab === "ingredientes" ? (
                  <Card
                    title="Ingredientes permitidos"
                    right={
                      <button
                        className="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                        onClick={openAddIngredientModal}
                      >
                        + Ingrediente
                      </button>
                    }
                  >
                    <div className="flex items-center gap-2 mb-3">
                      <div className="relative flex-1">
                        <IconSearch className="w-5 h-5 text-zinc-400 absolute left-3 top-1/2 -translate-y-1/2" />
                        <input
                          className="w-full rounded-xl border border-zinc-200 bg-white pl-10 pr-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-200"
                          placeholder="Buscar ingrediente..."
                          value={ingredientSearch}
                          onChange={(e)=> setIngredientSearch(e.target.value)}
                        />
                      </div>
                      <Badge>{filteredIngredients.length}</Badge>
                    </div>

                    <div className="text-sm text-zinc-600 mb-3">
                      Vista simple (solo nombres). Toc√° la flecha para ver detalles.
                    </div>

                    <div className="space-y-2">
                      {filteredIngredients.map(ing => {
                        const expanded = !!expandedIngredientIds[ing.id];
                        const isUnit = ing.unit === "u";
                        return (
                          <div key={ing.id} className="rounded-xl border border-zinc-200 bg-white p-3">
                            <div className="flex items-center justify-between gap-3">
                              <div className="flex items-center gap-2">
                                <button
                                  className="rounded-lg border border-zinc-200 px-2 py-1 text-sm hover:bg-zinc-50"
                                  onClick={()=> toggleExpandedIng(ing.id)}
                                  title={expanded ? "Ocultar" : "Mostrar"}
                                >
                                  {expanded ? "‚ñæ" : "‚ñ∏"}
                                </button>
                                <div className="font-semibold">{ing.name}</div>
                              </div>
                              <button
                                className="rounded-lg px-2 py-1 text-sm border border-red-200 text-red-700 hover:bg-red-50"
                                onClick={()=> { if (confirm("¬øEliminar ingrediente?")) removeIngredient(ing.id); }}
                              >
                                Eliminar
                              </button>
                            </div>

                            {expanded ? (
                              <div className="mt-3 grid grid-cols-1 md:grid-cols-4 gap-3">
                                <Select
                                  label="Categor√≠a"
                                  value={ing.category}
                                  onChange={(v)=> updateIngredient(ing.id, { category: v })}
                                  options={CATS.map(c => ({ key:c.key, label:c.label }))}
                                />
                                <Select
                                  label="Unidad"
                                  value={ing.unit}
                                  onChange={(v)=> {
                                    if (v === "u") {
                                      updateIngredient(ing.id, { unit: v, kcalPerUnit: ing.kcalPerUnit ?? 0 });
                                    } else {
                                      updateIngredient(ing.id, { unit: v, kcalPer100: ing.kcalPer100 ?? 0 });
                                    }
                                  }}
                                  options={UNITS}
                                />
                                <NumberField
                                  label="Porci√≥n base"
                                  value={ing.portionDefault ?? 0}
                                  onChange={(n)=> updateIngredient(ing.id, { portionDefault: n })}
                                  min={0} max={5000}
                                  suffix={ing.unit}
                                />
                                {isUnit ? (
                                  <NumberField
                                    label="kcal por unidad"
                                    value={ing.kcalPerUnit ?? 0}
                                    onChange={(n)=> updateIngredient(ing.id, { kcalPerUnit: n })}
                                    min={0} max={2000}
                                  />
                                ) : (
                                  <NumberField
                                    label="kcal por 100"
                                    value={ing.kcalPer100 ?? 0}
                                    onChange={(n)=> updateIngredient(ing.id, { kcalPer100: n })}
                                    min={0} max={2000}
                                    suffix={ing.unit === "ml" ? "ml" : "g"}
                                  />
                                )}
                                <div className="md:col-span-4">
                                  <TextField label="Nombre" value={ing.name} onChange={(v)=> updateIngredient(ing.id, { name: v })} />
                                </div>
                              </div>
                            ) : null}
                          </div>
                        );
                      })}
                    </div>
                  </Card>
                ) : null}

                {tab === "perfiles" ? (
                  <Card title="Gesti√≥n de perfiles" right={<Badge>{profiles.length}</Badge>}>
                    <div className="space-y-3">
                      {profiles.map(p => (
                        <div key={p.id} className="rounded-xl border border-zinc-200 bg-white p-3">
                          <div className="flex items-center justify-between">
                            <div className="font-semibold">{p.name}</div>
                            <div className="flex items-center gap-2">
                              <button
                                className="rounded-lg px-2 py-1 text-sm border border-zinc-200 hover:bg-zinc-50"
                                onClick={()=> setState(s => ({ ...s, activeProfileId: p.id }))}
                              >
                                Activar
                              </button>
                              <button
                                className="rounded-lg px-2 py-1 text-sm border border-red-200 text-red-700 hover:bg-red-50"
                                onClick={()=> { if (confirm("¬øEliminar perfil?")) removeProfile(p.id); }}
                              >
                                Eliminar
                              </button>
                            </div>
                          </div>
                          <div className="mt-2">
                            <TextField label="Nombre" value={p.name} onChange={(v)=> updateProfile(p.id, { name: v })} />
                          </div>
                        </div>
                      ))}
                      <button
                        className="w-full rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                        onClick={addProfile}
                      >
                        + Agregar perfil
                      </button>
                    </div>
                  </Card>
                ) : null}
              </div>
            </main>

            <footer className="max-w-6xl mx-auto px-4 pb-10">
              <div className="text-xs text-zinc-500">
                Guardado local (localStorage). Export√°/Import√° JSON para backup.
              </div>
            </footer>

            {/* Modal: Add/Edit Entry */}
            <Modal
              open={entryModalOpen}
              title={(editingEntryId ? "Editar" : "Agregar") + " ¬∑ " + (MEAL_COLS.find(x=>x.key===entryModalCol)?.label ?? entryModalCol)}
              onClose={closeEntryModal}
              footer={
                <div className="flex items-center justify-between">
                  <div className="text-sm text-zinc-600">
                    Total entrada: <span className="mono font-semibold">{draftTotals.kcal}</span> kcal
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50"
                      onClick={closeEntryModal}
                    >
                      Cancelar
                    </button>
                    <button
                      className="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800"
                      onClick={saveDraftToDay}
                    >
                      Guardar
                    </button>
                  </div>
                </div>
              }
            >
              <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <TextField
                    label="T√≠tulo (opcional)"
                    value={draft.title}
                    onChange={(v)=> setDraft(d => ({ ...d, title: v }))}
                    placeholder="Ej: Sandwich + fruta / Ensalada + pollo"
                  />
                  <label className="block">
                    <div className="text-xs font-semibold text-zinc-700 mb-1">Foto (opcional)</div>
                    <input
                      type="file"
                      accept="image/*"
                      className="w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm"
                      onChange={(e)=> {
                        const f = e.target.files?.[0];
                        if (f) handlePhotoUpload(f);
                        e.target.value = "";
                      }}
                    />
                    <div className="text-xs text-zinc-500 mt-1">Se guarda optimizada en el dispositivo.</div>
                  </label>
                </div>

                {draft.photoDataUrl ? (
                  <div className="rounded-xl border border-zinc-200 bg-zinc-50 p-3">
                    <div className="flex items-center justify-between">
                      <div className="text-sm font-semibold">Vista previa</div>
                      <button
                        className="rounded-lg px-2 py-1 text-sm border border-zinc-200 hover:bg-white"
                        onClick={()=> setDraft(d => ({ ...d, photoDataUrl:"", source:"manual" }))}
                      >
                        Quitar foto
                      </button>
                    </div>
                    <img src={draft.photoDataUrl} alt="foto" className="mt-2 w-full rounded-lg border border-zinc-200" />
                  </div>
                ) : null}

                <TextField
                  label="Notas (opcional) ¬∑ ac√° pod√©s corregir/explicar lo que la foto ‚Äúinterpret√≥‚Äù"
                  value={draft.notes}
                  onChange={(v)=> setDraft(d => ({ ...d, notes: v }))}
                  placeholder="Ej: ten√≠a 1 cda de aceite / era media porci√≥n / etc."
                />

                {/* Category filters */}
                <div className="rounded-xl border border-zinc-200 bg-white p-3">
                  <div className="flex items-center justify-between gap-3">
                    <div className="text-sm font-semibold">Ingredientes (buscar + agregar)</div>
                    <Badge>{(catFilter || []).length} categor√≠as</Badge>
                  </div>

                  <div className="mt-3 flex flex-wrap gap-2">
                    {(DEFAULT_CAT_FILTER.extras).map(cat => {
                      const on = (catFilter || []).includes(cat);
                      const label = CATS.find(c=>c.key===cat)?.label ?? cat;
                      return (
                        <button
                          key={cat}
                          className={[
                            "px-3 py-1.5 rounded-full text-sm border",
                            on ? "bg-zinc-900 text-white border-zinc-900" : "bg-white border-zinc-200 hover:bg-zinc-50"
                          ].join(" ")}
                          onClick={()=>{
                            setCatFilter(prev => {
                              const arr = prev ? [...prev] : [];
                              if (arr.includes(cat)) return arr.filter(x=>x!==cat);
                              return [...arr, cat];
                            });
                          }}
                        >
                          {label}
                        </button>
                      );
                    })}
                    <button
                      className="px-3 py-1.5 rounded-full text-sm border bg-white border-zinc-200 hover:bg-zinc-50"
                      onClick={()=> setCatFilter(DEFAULT_CAT_FILTER[entryModalCol] || DEFAULT_CAT_FILTER.extras)}
                      title="Volver al filtro recomendado para esta columna"
                    >
                      Reset
                    </button>
                  </div>

                  <div className="mt-3 relative">
                    <IconSearch className="w-5 h-5 text-zinc-400 absolute left-3 top-1/2 -translate-y-1/2" />
                    <input
                      className="w-full rounded-xl border border-zinc-200 bg-white pl-10 pr-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-200"
                      placeholder="Buscar ingrediente..."
                      value={ingSearch}
                      onChange={(e)=> setIngSearch(e.target.value)}
                    />
                  </div>

                  <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
                    {ingredientListForDraft.slice(0, 30).map(ing => (
                      <button
                        key={ing.id}
                        className="text-left rounded-xl border border-zinc-200 bg-zinc-50 px-3 py-2 hover:bg-white"
                        onClick={()=> addDraftItem(ing.id)}
                        title="Agregar al registro"
                      >
                        <div className="font-semibold text-sm">{ing.name}</div>
                        <div className="text-xs text-zinc-500">
                          {CATS.find(c=>c.key===ing.category)?.label ?? ing.category}
                          {" ¬∑ "}
                          porci√≥n base <span className="mono">{ing.portionDefault}</span> {ing.unit}
                        </div>
                      </button>
                    ))}
                    {ingredientListForDraft.length > 30 ? (
                      <div className="text-xs text-zinc-500 md:col-span-2">
                        Mostrando 30 resultados. Afin√° la b√∫squeda para ver m√°s.
                      </div>
                    ) : null}
                  </div>
                </div>

                {/* Draft items */}
                <div className="rounded-xl border border-zinc-200 bg-white p-3">
                  <div className="flex items-center justify-between">
                    <div className="text-sm font-semibold">Tu registro (editable)</div>
                    <Badge>{draft.items.length} items</Badge>
                  </div>

                  {draft.items.length === 0 ? (
                    <div className="text-sm text-zinc-600 mt-2">
                      Agreg√° ingredientes con el buscador. (O guard√° solo la foto/t√≠tulo si quer√©s.)
                    </div>
                  ) : (
                    <div className="mt-3 space-y-2">
                      {draft.items.map(it => {
                        const ing = ingById[it.ingredientId];
                        return (
                          <div key={it.ingredientId} className="rounded-xl border border-zinc-200 bg-zinc-50 p-3">
                            <div className="flex items-start justify-between gap-2">
                              <div>
                                <div className="font-semibold">{ing?.name ?? "?"}</div>
                                <div className="text-xs text-zinc-500">
                                  {CATS.find(c=>c.key===ing?.category)?.label ?? ing?.category}
                                  {" ¬∑ "}
                                  <span className="mono">{round(kcalForItem(ing, it.qty),0)}</span> kcal
                                </div>
                              </div>
                              <button
                                className="rounded-lg px-2 py-1 text-sm border border-red-200 text-red-700 hover:bg-red-50"
                                onClick={()=> removeDraftItem(it.ingredientId)}
                              >
                                Quitar
                              </button>
                            </div>

                            <div className="mt-2 grid grid-cols-2 gap-2 items-end">
                              <NumberField
                                label="Cantidad"
                                value={it.qty}
                                onChange={(n)=> updateDraftQty(it.ingredientId, n)}
                                min={0} max={10000}
                                suffix={ing?.unit ?? ""}
                              />
                              <div className="rounded-xl border border-zinc-200 bg-white p-2">
                                <div className="text-xs text-zinc-500">Sugerido (perfil)</div>
                                <div className="mono font-semibold">
                                  {round(suggestQty({ ing, mealCol: entryModalCol, targetKcal }),0)} {ing?.unit ?? ""}
                                </div>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            </Modal>

            {/* Modal: Add Ingredient */}
            <Modal
              open={addIngOpen}
              title="Agregar ingrediente"
              onClose={()=> setAddIngOpen(false)}
              footer={
                <div className="flex items-center justify-end gap-2">
                  <button className="rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm hover:bg-zinc-50" onClick={()=> setAddIngOpen(false)}>
                    Cancelar
                  </button>
                  <button className="rounded-xl bg-zinc-900 text-white px-3 py-2 text-sm hover:bg-zinc-800" onClick={saveNewIngredient}>
                    Guardar ingrediente
                  </button>
                </div>
              }
            >
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                <TextField label="Nombre" value={newIng.name} onChange={(v)=> setNewIng(x=>({ ...x, name:v }))} />
                <Select
                  label="Categor√≠a"
                  value={newIng.category}
                  onChange={(v)=> setNewIng(x=>({ ...x, category:v }))}
                  options={CATS.map(c => ({ key:c.key, label:c.label }))}
                />
                <Select
                  label="Unidad"
                  value={newIng.unit}
                  onChange={(v)=> setNewIng(x=>({ ...x, unit:v }))}
                  options={UNITS}
                />
                <NumberField
                  label="Porci√≥n base"
                  value={newIng.portionDefault}
                  onChange={(n)=> setNewIng(x=>({ ...x, portionDefault:n }))}
                  min={0} max={5000}
                  suffix={newIng.unit}
                />
                {newIng.unit === "u" ? (
                  <NumberField
                    label="kcal por unidad"
                    value={newIng.kcalPerUnit}
                    onChange={(n)=> setNewIng(x=>({ ...x, kcalPerUnit:n }))}
                    min={0} max={2000}
                  />
                ) : (
                  <NumberField
                    label="kcal por 100"
                    value={newIng.kcalPer100}
                    onChange={(n)=> setNewIng(x=>({ ...x, kcalPer100:n }))}
                    min={0} max={2000}
                    suffix={newIng.unit === "ml" ? "ml" : "g"}
                  />
                )}
                <div className="md:col-span-2 text-xs text-zinc-500">
                  Tip: si es ‚Äúpor unidad‚Äù (u), us√° kcal por unidad. Si es g/ml, us√° kcal por 100.
                </div>
              </div>
            </Modal>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>
